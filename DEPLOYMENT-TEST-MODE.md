# 部署脚本测试模式说明

## 当前状态

为了测试服务启动逻辑，已经将部署脚本中的以下操作注释掉：

### 已注释的操作

#### 1. 依赖检查

- `确保COS SDK依赖` - 注释掉了COS SDK依赖检查步骤

#### 2. CDN上传

- `上传静态资源到腾讯云COS` - 注释掉了CDN文件上传步骤
- `上传静态资源到CDN` - 注释掉了complete-deploy.yml中的CDN上传

#### 3. 文件同步

- `完整部署 - 直接rsync传输` - 注释掉了rsync文件传输
- `增量部署 - rsync传输` - 注释掉了增量部署的文件传输
- `部署完整项目到服务器` - 注释掉了complete-deploy.yml中的文件传输

### 保留的测试功能

#### 1. 构建和验证

- ✅ 代码检出
- ✅ Node.js环境设置
- ✅ 依赖安装和缓存
- ✅ 项目构建
- ✅ 构建输出检查
- ✅ 部署策略确定

#### 2. 服务启动测试

- ✅ `测试服务启动逻辑 (完整部署)` - 测试完整部署的服务启动
- ✅ `测试服务重启逻辑 (增量部署)` - 测试增量部署的服务重启
- ✅ `测试服务启动逻辑` (complete-deploy.yml) - 测试服务启动

#### 3. 部署验证

- ✅ 验证部署结果 - 检查服务状态和响应

## 测试内容

### 当前测试会执行：

1. **文件验证**
   - 检查 `server/entry.mjs` 是否存在
   - 检查 `package.json` 是否存在
   - 验证关键文件完整性

2. **环境配置**
   - 创建或验证 `.env` 文件
   - 设置正确的环境变量

3. **服务启动测试**
   - 调用 `deploy/start-service-with-pm2.sh` 脚本
   - 测试PM2服务启动逻辑
   - 验证端口监听和服务响应

4. **状态验证**
   - 检查Node.js进程状态
   - 检查端口3000监听状态
   - 测试HTTP响应

## 如何运行测试

### 方法1: 手动触发

在GitHub仓库页面：

1. 进入 `Actions` 标签页
2. 选择 `智能混合部署策略` 或 `完整部署到服务器`
3. 点击 `Run workflow`
4. 选择部署类型（如果需要）
5. 点击 `Run workflow` 开始测试

### 方法2: 推送触发

推送代码到 `main` 分支会自动触发测试

## 测试完成后恢复

测试完成后，需要取消注释以下内容来恢复正常部署功能：

### 在 `.github/workflows/deploy.yml` 中：

```yaml
# 取消注释这些步骤
- name: 确保COS SDK依赖
- name: 上传静态资源到腾讯云COS
- name: 完整部署 - 直接rsync传输
- name: 增量部署 - rsync传输
```

### 在 `.github/workflows/complete-deploy.yml` 中：

```yaml
# 取消注释这些步骤
- name: 确保COS SDK依赖
- name: 上传静态资源到CDN
- name: 部署完整项目到服务器
```

### 同时需要：

1. 将测试步骤名称改回原来的名称：
   - `测试服务启动逻辑 (完整部署)` → `完整部署 - 启动服务`
   - `测试服务重启逻辑 (增量部署)` → `增量部署 - 重启服务`
   - `测试服务启动逻辑` → `服务器端配置和启动`

2. 恢复原来的脚本内容（包括依赖安装、Nginx配置等）

## 预期测试结果

如果测试成功，你应该看到：

- ✅ PM2服务启动成功
- ✅ 端口3000正在监听
- ✅ 服务响应正常 (HTTP 200)
- ✅ Node.js进程运行正常

如果测试失败，会显示详细的错误信息和日志，帮助定位问题。

## 注意事项

1. 测试模式下不会更新服务器上的实际文件
2. 测试依赖于服务器上已有的项目文件
3. 如果服务器上没有必要的文件，测试会失败
4. 测试完成后记得恢复注释以启用完整部署功能
