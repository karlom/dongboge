name: æ™ºèƒ½æ··åˆéƒ¨ç½²ç­–ç•¥ - è§£å†³rsyncå’Œ404é”™è¯¯

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
        - full        # å®Œæ•´éƒ¨ç½²
        - incremental # å¢é‡éƒ¨ç½²
        - blog_only   # ä»…åšå®¢å†…å®¹

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ï¼Œç”¨äºæ¯”è¾ƒå˜æ›´

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: |
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm ci --prefer-offline --no-audit --silent --no-fund
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ç¡®ä¿COS SDKä¾èµ–
        run: |
          echo "ğŸ” æ£€æŸ¥COS SDKä¾èµ–..."
          chmod +x scripts/ensure-dependencies.cjs
          node scripts/ensure-dependencies.cjs
          echo "âœ… COS SDKæ£€æŸ¥å®Œæˆ"

      - name: æ„å»ºé¡¹ç›®
        env:
          PUBLIC_CDN_URL: https://cdn.dongboge.cn
          SITE_URL: https://dongboge.cn
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          NODE_ENV: production
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "ä½¿ç”¨çš„CDN URL: $PUBLIC_CDN_URL"
          npm run build
          echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"

      - name: æ£€æŸ¥æ„å»ºè¾“å‡º
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºè¾“å‡ºæ–‡ä»¶..."
          ls -la dist/
          echo "ğŸ“ æ£€æŸ¥æœåŠ¡ç«¯æ–‡ä»¶..."
          ls -la dist/server/ || echo "æ²¡æœ‰serverç›®å½•"
          echo "ğŸ“ æ£€æŸ¥æœåŠ¡ç«¯pagesæ–‡ä»¶..."
          find dist/server -name "*.mjs" | head -10 || echo "æœªæ‰¾åˆ°.mjsæ–‡ä»¶"
          echo "ğŸ“ æ£€æŸ¥å®¢æˆ·ç«¯æ–‡ä»¶..."
          ls -la dist/client/ || echo "æ²¡æœ‰clientç›®å½•"

      - name: ç¡®å®šéƒ¨ç½²ç­–ç•¥
        id: deploy_strategy
        run: |
          echo "ğŸ¤” åˆ†æéƒ¨ç½²ç­–ç•¥..."
          
          if [[ "${{ github.event.inputs.deploy_type }}" == "incremental" ]]; then
            echo "strategy=incremental" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ‰‹åŠ¨é€‰æ‹©ï¼šå¢é‡éƒ¨ç½²"
          elif [[ "${{ github.event.inputs.deploy_type }}" == "blog_only" ]]; then
            echo "strategy=blog_only" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ‰‹åŠ¨é€‰æ‹©ï¼šä»…åšå®¢éƒ¨ç½²"
          elif [[ "${{ github.event.inputs.deploy_type }}" == "full" ]]; then
            echo "strategy=full" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ‰‹åŠ¨é€‰æ‹©ï¼šå®Œæ•´éƒ¨ç½²"
          else
            # è‡ªåŠ¨æ£€æµ‹å˜æ›´æ–‡ä»¶
            if git diff --name-only HEAD~1 HEAD > /dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
              echo "ğŸ“‹ å˜æ›´çš„æ–‡ä»¶ï¼š"
              echo "$CHANGED_FILES"
              
              # æ£€æŸ¥æ˜¯å¦åªæœ‰åšå®¢æ–‡ä»¶å˜æ›´
              if echo "$CHANGED_FILES" | grep -E "^src/content/blog/" && ! echo "$CHANGED_FILES" | grep -v -E "^src/content/blog/|^README\.md$|\.md$"; then
                echo "strategy=blog_only" >> $GITHUB_OUTPUT
                echo "ğŸ¯ è‡ªåŠ¨æ£€æµ‹ï¼šä»…åšå®¢å†…å®¹å˜æ›´ï¼Œä½¿ç”¨å¢é‡éƒ¨ç½²"
              else
                echo "strategy=full" >> $GITHUB_OUTPUT
                echo "ğŸ¯ è‡ªåŠ¨æ£€æµ‹ï¼šæ ¸å¿ƒä»£ç å˜æ›´ï¼Œä½¿ç”¨å®Œæ•´éƒ¨ç½²"
              fi
            else
              echo "strategy=full" >> $GITHUB_OUTPUT
              echo "ğŸ¯ é»˜è®¤ï¼šä½¿ç”¨å®Œæ•´éƒ¨ç½²"
            fi
          fi

      - name: ä¸Šä¼ é™æ€èµ„æºåˆ°è…¾è®¯äº‘COS
        timeout-minutes: 15
        run: |
          echo "â˜ï¸ ä¸Šä¼ é™æ€èµ„æºåˆ°è…¾è®¯äº‘COS..."
          export TENCENT_SECRET_ID=${{ secrets.TENCENT_SECRET_ID }}
          export TENCENT_SECRET_KEY=${{ secrets.TENCENT_SECRET_KEY }}
          export TENCENT_COS_BUCKET=${{ secrets.TENCENT_COS_BUCKET }}
          export TENCENT_COS_REGION=ap-guangzhou
          export CDN_DOMAIN=$(echo ${{ secrets.CDN_DOMAIN }} | sed 's|^https://||' | sed 's|^http://||')
          
          chmod +x scripts/incremental-upload.cjs
          node scripts/incremental-upload.cjs

      # ==================== å®Œæ•´éƒ¨ç½²æµç¨‹ ====================
      - name: å®Œæ•´éƒ¨ç½² - åˆ›å»ºéƒ¨ç½²åŒ…
        if: steps.deploy_strategy.outputs.strategy == 'full'
        run: |
          echo "ğŸ“¦ åˆ›å»ºå®Œæ•´éƒ¨ç½²åŒ…..."
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          tar -czf deploy-${TIMESTAMP}.tar.gz -C dist .
          ls -la deploy-*.tar.gz
          echo "âœ… éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"

      - name: å®Œæ•´éƒ¨ç½² - æœåŠ¡å™¨å‡†å¤‡
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            set -e
            echo "ğŸš€ å¼€å§‹å®Œæ•´éƒ¨ç½²å‡†å¤‡..."
            
            # 1. åˆ›å»ºå®Œæ•´ç›®å½•ç»“æ„
            echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."
            mkdir -p /var/www/dongboge/{server/pages/{admin,api,blog},client,logs,backup}
            
            # 2. è®¾ç½®æƒé™
            echo "ğŸ” è®¾ç½®ç›®å½•æƒé™..."
            sudo chown -R $USER:$USER /var/www/dongboge
            chmod -R 755 /var/www/dongboge
            
            # 3. å¤‡ä»½ç°æœ‰éƒ¨ç½²
            echo "ğŸ’¾ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
            cd /var/www
            if [ -d "dongboge/server" ]; then
              tar -czf dongboge/backup/backup-$(date +%Y%m%d-%H%M%S).tar.gz dongboge/ 2>/dev/null || echo "âš ï¸ å¤‡ä»½è·³è¿‡"
              # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
              cd dongboge/backup && ls -t backup-*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null || true
            fi
            
            # 4. åœæ­¢ç°æœ‰æœåŠ¡
            echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
            # å°è¯•ä½¿ç”¨PM2åœæ­¢
            if command -v pm2 >/dev/null 2>&1; then
              pm2 stop dongboge 2>/dev/null || echo "PM2æœåŠ¡æœªè¿è¡Œ"
              pm2 delete dongboge 2>/dev/null || echo "PM2åº”ç”¨ä¸å­˜åœ¨"
            fi
            
            # å¼ºåˆ¶åœæ­¢Node.jsè¿›ç¨‹
            for pid in $(ps aux | grep 'node.*server/entry.mjs' | grep -v grep | awk '{print $2}'); do
              echo "åœæ­¢è¿›ç¨‹ $pid"
              kill -15 $pid 2>/dev/null || true
              sleep 2
              kill -9 $pid 2>/dev/null || true
            done
            
            echo "âœ… æœåŠ¡å™¨å‡†å¤‡å®Œæˆ"

      - name: å®Œæ•´éƒ¨ç½² - ä¸Šä¼ éƒ¨ç½²åŒ…
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          source: "deploy-*.tar.gz"
          target: "/tmp/"

      - name: å®Œæ•´éƒ¨ç½² - è§£å‹å’Œå¯åŠ¨
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          command_timeout: 10m
          script: |
            set -e
            echo "ğŸ“¦ è§£å‹å’Œéƒ¨ç½²..."
            cd /var/www/dongboge
            
            # è§£å‹éƒ¨ç½²åŒ…
            echo "ğŸ“‚ è§£å‹éƒ¨ç½²åŒ…..."
            tar -xzf /tmp/deploy-*.tar.gz
            rm /tmp/deploy-*.tar.gz
            
            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            echo "ğŸ” éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..."
            echo "=== ç›®å½•ç»“æ„ ==="
            ls -la
            echo "=== æœåŠ¡ç«¯æ–‡ä»¶ ==="
            ls -la server/ || echo "serverç›®å½•ä¸å­˜åœ¨"
            echo "=== Pagesæ–‡ä»¶ ==="
            ls -la server/pages/ || echo "pagesç›®å½•ä¸å­˜åœ¨"
            echo "=== .mjsæ–‡ä»¶æ•°é‡ ==="
            find server -name "*.mjs" | wc -l || echo "0"
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            REQUIRED_FILES=("server/entry.mjs" "package.json")
            for file in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±: $file"
                exit 1
              else
                echo "âœ… å…³é”®æ–‡ä»¶å­˜åœ¨: $file"
              fi
            done
            
            # å®‰è£…ç”Ÿäº§ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
            npm install --production --silent
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            echo "ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡..."
            cat > .env << EOF
            PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
            PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
            PUBLIC_CDN_URL=https://cdn.dongboge.cn
            SITE_URL=https://dongboge.cn
            NODE_ENV=production
            HOST=127.0.0.1
            PORT=3000
            EOF
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            mkdir -p logs
            
            # æ£€æŸ¥entry.mjsæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "server/entry.mjs" ]; then
              echo "âŒ server/entry.mjs æ–‡ä»¶ä¸å­˜åœ¨ï¼"
              echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
              ls -la
              echo "serverç›®å½•å†…å®¹ï¼š"
              ls -la server/ || echo "serverç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            # å®‰è£…PM2ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "ğŸ“¦ å®‰è£…PM2..."
              npm install -g pm2
            fi
            
            # ä½¿ç”¨PM2å¯åŠ¨æœåŠ¡
            echo "ä½¿ç”¨PM2å¯åŠ¨æœåŠ¡..."
            pm2 start server/entry.mjs --name dongboge --log logs/server.log --error logs/error.log --out logs/out.log
            pm2 save
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 8
            
            # æ£€æŸ¥PM2çŠ¶æ€
            echo "=== PM2çŠ¶æ€ ==="
            pm2 status
            
            # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
            echo "=== è¿›ç¨‹æ£€æŸ¥ ==="
            ps aux | grep "node.*server/entry.mjs" | grep -v grep || echo "æ²¡æœ‰æ‰¾åˆ°Node.jsè¿›ç¨‹"
            
            # æ£€æŸ¥ç«¯å£ç›‘å¬
            echo "=== ç«¯å£æ£€æŸ¥ ==="
            netstat -tlnp | grep :3000 || echo "ç«¯å£3000æœªè¢«ç›‘å¬"
            
            # å¦‚æœPM2å¯åŠ¨å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¯åŠ¨
            if ! ps aux | grep "node.*server/entry.mjs" | grep -v grep > /dev/null; then
              echo "âš ï¸ PM2å¯åŠ¨å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¯åŠ¨..."
              pm2 logs dongboge --lines 10 || echo "æ— æ³•è·å–PM2æ—¥å¿—"
              
              echo "ä½¿ç”¨nohupç›´æ¥å¯åŠ¨..."
              nohup node server/entry.mjs > logs/server.log 2>&1 &
              sleep 5
              
              if ps aux | grep "node.*server/entry.mjs" | grep -v grep > /dev/null; then
                echo "âœ… ç›´æ¥å¯åŠ¨æˆåŠŸ"
              else
                echo "âŒ æœåŠ¡å¯åŠ¨å®Œå…¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                tail -20 logs/server.log || echo "æ— æ³•è¯»å–æ—¥å¿—"
                echo "=== é”™è¯¯æ’æŸ¥ ==="
                echo "Node.jsç‰ˆæœ¬: $(node --version)"
                echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
                echo "ç¯å¢ƒå˜é‡:"
                cat .env || echo "æ²¡æœ‰.envæ–‡ä»¶"
                exit 1
              fi
            else
              echo "âœ… PM2å¯åŠ¨æˆåŠŸ"
            fi
            
            echo "âœ… å®Œæ•´éƒ¨ç½²æˆåŠŸï¼"
            
            # åˆ›å»ºå†…è”ä¿®å¤è„šæœ¬ï¼ˆè§£å†³scriptsæ–‡ä»¶å¤¹ä¸å­˜åœ¨çš„é—®é¢˜ï¼‰
            echo "ğŸ”§ åˆ›å»ºæœåŠ¡å™¨ä¿®å¤è„šæœ¬..."
            cat > fix-server.sh << 'SCRIPT_EOF'
#!/bin/bash
echo "ğŸš€ å¼€å§‹æœåŠ¡å™¨ä¿®å¤..."

# æ£€æŸ¥å…³é”®æ–‡ä»¶
if [ ! -f "server/entry.mjs" ]; then
    echo "âŒ server/entry.mjs ä¸å­˜åœ¨ï¼"
    exit 1
fi

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p logs backup

# å®‰è£…PM2ï¼ˆå¦‚æœéœ€è¦ï¼‰
if ! command -v pm2 >/dev/null 2>&1; then
    echo "ğŸ“¦ å®‰è£…PM2..."
    npm install -g pm2
fi

# åœæ­¢ç°æœ‰æœåŠ¡
echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
pm2 stop dongboge 2>/dev/null || true
pm2 delete dongboge 2>/dev/null || true
pkill -f "node.*server/entry.mjs" 2>/dev/null || true

sleep 2

# å¯åŠ¨æœåŠ¡
echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
pm2 start server/entry.mjs --name dongboge --log logs/server.log --error logs/error.log --out logs/out.log
pm2 save

sleep 5

# æ£€æŸ¥çŠ¶æ€
if ps aux | grep "node.*server/entry.mjs" | grep -v grep > /dev/null; then
    echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
    pm2 status dongboge
    
    # æ£€æŸ¥ç«¯å£
    if netstat -tlnp | grep :3000 > /dev/null; then
        echo "âœ… ç«¯å£3000æ­£åœ¨ç›‘å¬"
        
        # æµ‹è¯•å“åº”
        sleep 3
        LOCAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/ 2>/dev/null || echo "ERROR")
        echo "æœ¬åœ°å“åº”: $LOCAL_RESPONSE"
        
        if [ "$LOCAL_RESPONSE" = "200" ]; then
            echo "ğŸ‰ æœåŠ¡å®Œå…¨æ­£å¸¸ï¼"
        else
            echo "âš ï¸ æœåŠ¡å¯åŠ¨ä½†å“åº”å¼‚å¸¸"
            tail -10 logs/server.log
        fi
    else
        echo "âŒ ç«¯å£3000æœªç›‘å¬"
        pm2 logs dongboge --lines 10
    fi
else
    echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
    pm2 logs dongboge --lines 10
    
    # å°è¯•ç›´æ¥å¯åŠ¨
    echo "å°è¯•ç›´æ¥å¯åŠ¨..."
    nohup node server/entry.mjs > logs/server.log 2>&1 &
    sleep 5
    
    if ps aux | grep "node.*server/entry.mjs" | grep -v grep > /dev/null; then
        echo "âœ… ç›´æ¥å¯åŠ¨æˆåŠŸ"
    else
        echo "âŒ æ‰€æœ‰å¯åŠ¨æ–¹æ³•éƒ½å¤±è´¥"
        tail -20 logs/server.log
        exit 1
    fi
fi

echo "ä¿®å¤å®Œæˆï¼"
SCRIPT_EOF

            chmod +x fix-server.sh
            echo "âœ… ä¿®å¤è„šæœ¬å·²åˆ›å»º"

      # ==================== å¢é‡éƒ¨ç½²æµç¨‹ ====================
      - name: å¢é‡éƒ¨ç½² - rsyncä¼ è¾“
        if: steps.deploy_strategy.outputs.strategy == 'incremental' || steps.deploy_strategy.outputs.strategy == 'blog_only'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avz --checksum --delete --rsync-path="mkdir -p /var/www/dongboge && rsync"
          path: dist/
          remote_path: /var/www/dongboge
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: å¢é‡éƒ¨ç½² - é‡å¯æœåŠ¡
        if: steps.deploy_strategy.outputs.strategy == 'incremental' || steps.deploy_strategy.outputs.strategy == 'blog_only'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            echo "ğŸ”„ å¢é‡éƒ¨ç½²åé‡å¯æœåŠ¡..."
            cd /var/www/dongboge
            
            # å®‰è£…ä¾èµ–ï¼ˆå¦‚æœpackage.jsonæœ‰å˜åŒ–ï¼‰
            npm install --production --silent
            
            # é‡å¯æœåŠ¡
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart dongboge || pm2 start server/entry.mjs --name dongboge --log logs/server.log
            else
              pkill -f "node.*server/entry.mjs" || echo "æ²¡æœ‰è¿è¡Œçš„è¿›ç¨‹"
              nohup node server/entry.mjs > logs/server.log 2>&1 &
            fi
            
            echo "âœ… å¢é‡éƒ¨ç½²å®Œæˆï¼"

      # ==================== éƒ¨ç½²éªŒè¯ ====================
      - name: éªŒè¯éƒ¨ç½²ç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            echo "ğŸ§ª éªŒè¯éƒ¨ç½²ç»“æœ..."
            cd /var/www/dongboge
            
            echo "=== æ–‡ä»¶ç»“æ„éªŒè¯ ==="
            ls -la server/pages/ | head -10 || echo "pagesç›®å½•ä¸ºç©º"
            echo "æœåŠ¡ç«¯.mjsæ–‡ä»¶æ•°é‡: $(find server -name '*.mjs' | wc -l)"
            
            echo "=== è¿›ç¨‹çŠ¶æ€éªŒè¯ ==="
            if command -v pm2 >/dev/null 2>&1; then
              pm2 status dongboge 2>/dev/null || echo "PM2çŠ¶æ€è·å–å¤±è´¥"
            fi
            ps aux | grep "node.*server/entry.mjs" | grep -v grep || echo "æ²¡æœ‰æ‰¾åˆ°Node.jsè¿›ç¨‹"
            
            echo "=== ç«¯å£ç›‘å¬éªŒè¯ ==="
            netstat -tlnp | grep :3000 || echo "ç«¯å£3000æœªè¢«ç›‘å¬"
            
            echo "=== æœåŠ¡å“åº”éªŒè¯ ==="
            sleep 3
            LOCAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/ 2>/dev/null || echo "ERROR")
            echo "æœ¬åœ°å“åº”: $LOCAL_RESPONSE"
            
            EXTERNAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/ 2>/dev/null || echo "ERROR")
            echo "å¤–éƒ¨å“åº”: $EXTERNAL_RESPONSE"
            
            # æµ‹è¯•å…³é”®é¡µé¢
            CONTACT_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/contact 2>/dev/null || echo "ERROR")
            echo "Contacté¡µé¢: $CONTACT_RESPONSE"
            
            if [ "$LOCAL_RESPONSE" = "200" ] && [ "$EXTERNAL_RESPONSE" = "200" ]; then
              echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸï¼"
            else
              echo "âš ï¸ éƒ¨ç½²å¯èƒ½å­˜åœ¨é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              tail -20 logs/server.log 2>/dev/null || echo "æ— æ³•è¯»å–æ—¥å¿—"
            fi
            
            echo "=== éƒ¨ç½²å®Œæˆæ€»ç»“ ==="
            echo "éƒ¨ç½²ç­–ç•¥: ${{ steps.deploy_strategy.outputs.strategy }}"
            echo "éƒ¨ç½²æ—¶é—´: $(date)"
            echo "æœåŠ¡çŠ¶æ€: $([ "$LOCAL_RESPONSE" = "200" ] && echo "æ­£å¸¸" || echo "å¼‚å¸¸")"