name: åšå®¢å¿«é€Ÿéƒ¨ç½²

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto        # è‡ªåŠ¨æ£€æµ‹
        - full        # å®Œæ•´éƒ¨ç½²
        - blog_only   # ä»…åšå®¢å†…å®¹

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit --silent

      - name: æ„å»ºé¡¹ç›®
        env:
          PUBLIC_CDN_URL: https://cdn.dongboge.cn
          SITE_URL: https://dongboge.cn
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          NODE_ENV: production
        run: npm run build

      - name: æ£€æµ‹éƒ¨ç½²ç­–ç•¥
        id: strategy
        run: |
          if [[ "${{ github.event.inputs.deploy_type }}" == "full" ]]; then
            echo "type=full" >> $GITHUB_OUTPUT
            echo "ğŸ”„ æ‰‹åŠ¨é€‰æ‹©ï¼šå®Œæ•´éƒ¨ç½²"
          elif [[ "${{ github.event.inputs.deploy_type }}" == "blog_only" ]]; then
            echo "type=blog_only" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ‰‹åŠ¨é€‰æ‹©ï¼šä»…åšå®¢éƒ¨ç½²"
          else
            # è‡ªåŠ¨æ£€æµ‹å˜æ›´
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
            echo "å˜æ›´æ–‡ä»¶: $CHANGED_FILES"
            
            if echo "$CHANGED_FILES" | grep -E "^src/content/blog/" && ! echo "$CHANGED_FILES" | grep -v -E "^src/content/blog/|\.md$"; then
              echo "type=blog_only" >> $GITHUB_OUTPUT
              echo "ğŸ“ è‡ªåŠ¨æ£€æµ‹ï¼šä»…åšå®¢å†…å®¹å˜æ›´"
            else
              echo "type=full" >> $GITHUB_OUTPUT
              echo "ğŸ”„ è‡ªåŠ¨æ£€æµ‹ï¼šä»£ç å˜æ›´ï¼Œå®Œæ•´éƒ¨ç½²"
            fi
          fi

      - name: CDNå¢é‡æ›´æ–°
        run: |
          echo "â˜ï¸ æ›´æ–°CDNèµ„æº..."
          export TENCENT_SECRET_ID=${{ secrets.TENCENT_SECRET_ID }}
          export TENCENT_SECRET_KEY=${{ secrets.TENCENT_SECRET_KEY }}
          export TENCENT_COS_BUCKET=${{ secrets.TENCENT_COS_BUCKET }}
          export TENCENT_COS_REGION=ap-guangzhou
          export CDN_DOMAIN=$(echo ${{ secrets.CDN_DOMAIN }} | sed 's|^https://||')
          
          node scripts/upload-to-cos.js

      # ä»…åšå®¢éƒ¨ç½² - å¿«é€Ÿæ›´æ–°
      - name: åšå®¢å¿«é€Ÿéƒ¨ç½²
        if: steps.strategy.outputs.type == 'blog_only'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            echo "ğŸ“ åšå®¢å¿«é€Ÿæ›´æ–°..."
            cd /var/www/dongboge
            
            # åªæ›´æ–°åšå®¢ç›¸å…³çš„é™æ€æ–‡ä»¶
            rsync -av --delete /tmp/blog-update/ ./blog/ 2>/dev/null || echo "åšå®¢æ–‡ä»¶åŒæ­¥è·³è¿‡"
            
            # é‡å¯æœåŠ¡ä»¥æ›´æ–°å†…å®¹
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart dongboge
              echo "âœ… PM2æœåŠ¡å·²é‡å¯"
            else
              pkill -f "node.*server/entry.mjs" 2>/dev/null || true
              nohup node server/entry.mjs > logs/server.log 2>&1 &
              echo "âœ… æœåŠ¡å·²é‡å¯"
            fi
            
            echo "ğŸ“ åšå®¢æ›´æ–°å®Œæˆï¼"

      - name: ä¸Šä¼ åšå®¢æ–‡ä»¶
        if: steps.strategy.outputs.type == 'blog_only'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          source: "dist/blog/"
          target: "/var/www/dongboge/"
          strip_components: 1

      # å®Œæ•´éƒ¨ç½² - å…¨é‡æ›´æ–°
      - name: å®Œæ•´éƒ¨ç½²
        if: steps.strategy.outputs.type == 'full'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avz --delete --exclude=logs --exclude=node_modules --exclude=.env
          path: dist/
          remote_path: /var/www/dongboge
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: é‡å¯æœåŠ¡
        if: steps.strategy.outputs.type == 'full'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            echo "ğŸš€ é‡å¯æœåŠ¡..."
            cd /var/www/dongboge
            
            # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if [ ! -f ".env" ]; then
              cat > .env << EOF
            PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
            PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
            PUBLIC_CDN_URL=https://cdn.dongboge.cn
            SITE_URL=https://dongboge.cn
            NODE_ENV=production
            HOST=127.0.0.1
            PORT=3000
            EOF
            fi
            
            # é‡å¯æœåŠ¡
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart dongboge || pm2 start server/entry.mjs --name dongboge --log logs/server.log
              echo "âœ… PM2æœåŠ¡å·²é‡å¯"
            else
              pkill -f "node.*server/entry.mjs" 2>/dev/null || true
              sleep 2
              nohup node server/entry.mjs > logs/server.log 2>&1 &
              echo "âœ… æœåŠ¡å·²é‡å¯"
            fi

      - name: éªŒè¯éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            echo "ğŸ§ª éªŒè¯éƒ¨ç½²..."
            cd /var/www/dongboge
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if ps aux | grep "node.*server/entry.mjs" | grep -v grep > /dev/null; then
              echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
              
              # æµ‹è¯•å“åº”
              LOCAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/ 2>/dev/null || echo "ERROR")
              SITE_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/ 2>/dev/null || echo "ERROR")
              
              echo "æœ¬åœ°å“åº”: $LOCAL_RESPONSE"
              echo "ç½‘ç«™å“åº”: $SITE_RESPONSE"
              
              if [ "$LOCAL_RESPONSE" = "200" ] && [ "$SITE_RESPONSE" = "200" ]; then
                echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼ç½‘ç«™æ­£å¸¸è¿è¡Œ"
              else
                echo "âš ï¸ å“åº”å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                tail -10 logs/server.log 2>/dev/null || echo "æ— æ—¥å¿—"
              fi
            else
              echo "âŒ æœåŠ¡æœªè¿è¡Œï¼Œå°è¯•ä¿®å¤..."
              ./fix-file-structure.sh $(hostname -I | awk '{print $1}') $USER ~/.ssh/id_rsa 2>/dev/null || echo "ä¿®å¤è„šæœ¬ä¸å­˜åœ¨"
            fi
            
            echo "éƒ¨ç½²ç±»å‹: ${{ steps.strategy.outputs.type }}"
            echo "å®Œæˆæ—¶é—´: $(date)"