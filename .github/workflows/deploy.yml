name: åšå®¢å¿«é€Ÿéƒ¨ç½²

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
        - name: ğŸ“¥ æ£€å‡ºä»£ç 
          uses: actions/checkout@v4
          with:
            fetch-depth: 2

        - name: ğŸ” æ£€æµ‹å˜æ›´ç±»å‹
          id: detect_changes
          run: |
            # æ£€æŸ¥æ˜¯å¦åªæœ‰åšå®¢æ–‡ä»¶å˜æ›´
            BLOG_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep "src/content/blog/" | wc -l)
            OTHER_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep -v "src/content/blog/" | wc -l)
            
            echo "åšå®¢æ–‡ä»¶å˜æ›´: $BLOG_CHANGES"
            echo "å…¶ä»–æ–‡ä»¶å˜æ›´: $OTHER_CHANGES"
            
            if [ $BLOG_CHANGES -gt 0 ] && [ $OTHER_CHANGES -eq 0 ]; then
              echo "deployment_type=blog_only" >> $GITHUB_OUTPUT
              echo "ğŸ” æ£€æµ‹åˆ°ï¼šä»…åšå®¢å†…å®¹æ›´æ–°"
            else
              echo "deployment_type=full" >> $GITHUB_OUTPUT
              echo "ğŸ” æ£€æµ‹åˆ°ï¼šä»£ç åŠŸèƒ½æ›´æ–°"
            fi

        - name: ğŸ—ï¸ è®¾ç½® Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '18'
            cache: 'npm'

        - name: ğŸ“¦ ç¡®ä¿ä¾èµ–
          run: |
            echo "ğŸ“¦ æ£€æŸ¥ä¾èµ–..."
            node scripts/ensure-dependencies.cjs

        - name: ğŸ”¨ æ„å»ºé¡¹ç›®
          run: |
            echo "ğŸ”¨ æ„å»º Astro é¡¹ç›®..."
            npm run build

        - name: ğŸ“¤ å¢é‡ä¸Šä¼ CDNèµ„æº
          run: |
            echo "â˜ï¸ å¢é‡æ›´æ–°CDNèµ„æº..."
            node scripts/incremental-upload.cjs
          env:
            TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
            TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
            TENCENT_COS_BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
            TENCENT_COS_REGION: ${{ secrets.TENCENT_COS_REGION }}
            CDN_DOMAIN: ${{ secrets.CDN_DOMAIN }}

        - name: ğŸš€ å¿«é€Ÿéƒ¨ç½² (ä»…åšå®¢æ›´æ–°)
          if: steps.detect_changes.outputs.deployment_type == 'blog_only'
          uses: easingthemes/ssh-deploy@main
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
            ARGS: "-rlgoDzvc -i --exclude=node_modules/ --exclude=.git/"
            SOURCE: "dist/"
            REMOTE_HOST: ${{ secrets.HOST }}
            REMOTE_USER: ${{ secrets.USERNAME }}
            REMOTE_PORT: ${{ secrets.PORT }}
            TARGET: "/var/www/dongboge/"
            SCRIPT_AFTER: |
              echo "ğŸ”„ é‡å¯æœåŠ¡..."
              sudo systemctl restart dongboge
              echo "âœ… åšå®¢æ›´æ–°å®Œæˆ"

        - name: ğŸš€ å®Œæ•´éƒ¨ç½² (åŠŸèƒ½æ›´æ–°)
          if: steps.detect_changes.outputs.deployment_type == 'full'
          uses: easingthemes/ssh-deploy@main
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
            ARGS: "-rlgoDzvc -i --delete-after --exclude=node_modules/ --exclude=.git/"
            SOURCE: "dist/"
            REMOTE_HOST: ${{ secrets.HOST }}
            REMOTE_USER: ${{ secrets.USERNAME }}
            REMOTE_PORT: ${{ secrets.PORT }}
            TARGET: "/var/www/dongboge/"
            SCRIPT_AFTER: |
              echo "ğŸ”§ å®Œæ•´éƒ¨ç½²å¤„ç†..."
              sudo chown -R www-data:www-data /var/www/dongboge
              sudo chmod -R 755 /var/www/dongboge
              sudo systemctl restart nginx
              sudo systemctl restart dongboge
              echo "âœ… å®Œæ•´éƒ¨ç½²å®Œæˆ"

        - name: âœ… éƒ¨ç½²å®Œæˆ
          run: |
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ è®¿é—®: https://dongboge.cn"