name: 智能混合部署策略 - 解决rsync和404错误

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: "部署类型"
        required: true
        default: "full"
        type: choice
        options:
          - full # 完整部署
          - incremental # 增量部署
          - blog_only # 仅博客内容

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # 获取最近两次提交，用于比较变更

      - name: 设置Node.js环境
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: 缓存依赖
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: |
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: 安装依赖
        run: |
          echo "📦 开始安装项目依赖..."
          npm ci --prefer-offline --no-audit --silent --no-fund
          echo "✅ 依赖安装完成"

      - name: 确保COS SDK依赖
        run: |
          echo "🔍 检查COS SDK依赖..."
          chmod +x scripts/ensure-dependencies.cjs
          node scripts/ensure-dependencies.cjs
          echo "✅ COS SDK检查完成"

      - name: 构建项目
        env:
          PUBLIC_CDN_URL: https://cdn.dongboge.cn
          SITE_URL: https://dongboge.cn
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          NODE_ENV: production
        run: |
          echo "🔨 开始构建项目..."
          echo "使用的CDN URL: $PUBLIC_CDN_URL"
          npm run build
          echo "✅ 项目构建完成"

      - name: 检查构建输出
        run: |
          echo "🔍 检查构建输出文件..."
          ls -la dist/
          echo "📁 检查服务端文件..."
          ls -la dist/server/ || echo "没有server目录"
          echo "📁 检查服务端pages文件..."
          find dist/server -name "*.mjs" | head -10 || echo "未找到.mjs文件"
          echo "📁 检查客户端文件..."
          ls -la dist/client/ || echo "没有client目录"

      - name: 确定部署策略
        id: deploy_strategy
        run: |
          echo "🤔 分析部署策略..."

          if [[ "${{ github.event.inputs.deploy_type }}" ]]; then
            echo "strategy=${{ github.event.inputs.deploy_type }}" >> $GITHUB_OUTPUT
            echo "📝 手动选择：${{ github.event.inputs.deploy_type }}部署"
          else
            # 简化的自动检测变更文件逻辑
            if git diff --name-only HEAD~1 HEAD > /dev/null 2>&1; then
              # 只检查关键文件变更
              CORE_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep -v -E "^src/content/blog/|^README\.md$|^\.md$|^docs/" || true)
              
              if [ -z "$CORE_CHANGES" ]; then
                echo "strategy=incremental" >> $GITHUB_OUTPUT
                echo "🎯 自动检测：仅内容变更，使用增量部署"
              else
                echo "strategy=full" >> $GITHUB_OUTPUT
                echo "🎯 自动检测：核心代码变更，使用完整部署"
              fi
            else
              echo "strategy=full" >> $GITHUB_OUTPUT
              echo "🎯 默认：使用完整部署"
            fi
          fi

      - name: 上传静态资源到腾讯云COS
        timeout-minutes: 10
        run: |
          echo "☁️ 上传静态资源到腾讯云COS..."
          export TENCENT_SECRET_ID=${{ secrets.TENCENT_SECRET_ID }}
          export TENCENT_SECRET_KEY=${{ secrets.TENCENT_SECRET_KEY }}
          export TENCENT_COS_BUCKET=${{ secrets.TENCENT_COS_BUCKET }}
          export TENCENT_COS_REGION=ap-guangzhou
          export CDN_DOMAIN=$(echo ${{ secrets.CDN_DOMAIN }} | sed 's|^https://||' | sed 's|^http://||')

          # 使用快速上传策略
          chmod +x scripts/fast-cos-upload.cjs
          echo "🚀 使用快速上传策略..."
          node scripts/fast-cos-upload.cjs

      # ==================== 完整部署流程 ====================

      - name: 完整部署 - 服务器准备
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            set -e
            echo "🚀 开始服务器准备..."

            # 创建目录结构
            mkdir -p /var/www/dongboge/{server,client,logs,backup,node_modules} >/dev/null 2>&1
            sudo chown -R $USER:$USER /var/www/dongboge >/dev/null 2>&1
            chmod -R 755 /var/www/dongboge >/dev/null 2>&1
            echo "📁 目录结构已创建"

            # 备份现有部署
            cd /var/www
            if [ -d "dongboge/server" ] && [ -f "dongboge/server/entry.mjs" ]; then
              tar -czf dongboge/backup/backup-$(date +%Y%m%d-%H%M%S).tar.gz dongboge/server dongboge/client dongboge/package.json dongboge/.env >/dev/null 2>&1 || true
              cd dongboge/backup && ls -t backup-*.tar.gz | tail -n +6 | xargs rm -f >/dev/null 2>&1 || true
              echo "💾 已备份现有部署"
            fi

            # 停止现有服务
            if command -v pm2 >/dev/null 2>&1; then
              pm2 stop dongboge >/dev/null 2>&1 || true
              pm2 delete dongboge >/dev/null 2>&1 || true
            fi

            for pid in $(ps aux | grep 'node.*server/entry.mjs' | grep -v grep | awk '{print $2}' 2>/dev/null); do
              kill -15 $pid >/dev/null 2>&1 || true
              sleep 1
              kill -9 $pid >/dev/null 2>&1 || true
            done
            echo "🛑 已停止现有服务"

            echo "✅ 服务器准备完成"

      - name: 完整部署 - 直接rsync传输
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rltz --delete --rsync-path="mkdir -p /var/www/dongboge && rsync"
          path: dist/
          remote_path: /var/www/dongboge
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: 完整部署 - 传输项目根文件
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rltz --rsync-path="rsync"
          path: package.json
          remote_path: /var/www/dongboge/package.json
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: 完整部署 - 传输部署脚本
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rltz --rsync-path="mkdir -p /var/www/dongboge/deploy && rsync"
          path: deploy/
          remote_path: /var/www/dongboge/deploy
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: 完整部署 - 启动服务
        if: steps.deploy_strategy.outputs.strategy == 'full'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          command_timeout: 10m
          script: |
            set -e
            echo "📦 开始部署..."
            cd /var/www/dongboge

            # 验证关键文件是否存在
            if [ ! -f "server/entry.mjs" ]; then
              echo "❌ 关键文件缺失: server/entry.mjs"
              echo "📁 当前目录内容:"
              ls -la
              exit 1
            fi

            if [ ! -f "package.json" ]; then
              echo "❌ 关键文件缺失: package.json"
              exit 1
            fi

            echo "🔍 文件验证通过"

            # 运行文件修复脚本（如果需要）
            if [ -f "deploy/fix-missing-files.sh" ]; then
              echo "🔧 运行文件修复脚本..."
              chmod +x deploy/fix-missing-files.sh
              ./deploy/fix-missing-files.sh
            fi

            # 确保.env文件存在
            if [ ! -f ".env" ]; then
              echo "📝 创建.env文件..."
              cat > .env << EOF
            PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
            PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
            PUBLIC_CDN_URL=https://cdn.dongboge.cn
            SITE_URL=https://dongboge.cn
            NODE_ENV=production
            HOST=127.0.0.1
            PORT=3000
            EOF
              echo "✅ .env文件已创建"
            fi

            # 使用专门的启动脚本启动服务
            echo "🚀 启动PM2服务..."
            if [ -f "deploy/start-service-with-pm2.sh" ]; then
              chmod +x deploy/start-service-with-pm2.sh
              ./deploy/start-service-with-pm2.sh
              echo "✅ 服务启动成功！"
            else
              echo "❌ 启动脚本不存在: deploy/start-service-with-pm2.sh"
              exit 1
            fi

            # 更新Nginx配置
            echo "🔧 更新Nginx配置..."
            if [ -f "deploy/deploy-nginx-config.sh" ]; then
              chmod +x deploy/deploy-nginx-config.sh
              ./deploy/deploy-nginx-config.sh
              
              # 重载Nginx
              echo "🔄 重载Nginx..."
              sudo systemctl reload nginx
              echo "✅ Nginx配置更新完成"
            else
              echo "⚠️ Nginx配置脚本不存在，跳过配置更新"
            fi

      # ==================== 增量部署流程 ====================
      - name: 增量部署 - rsync传输
        if: steps.deploy_strategy.outputs.strategy == 'incremental' || steps.deploy_strategy.outputs.strategy == 'blog_only'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rltz --delete --rsync-path="mkdir -p /var/www/dongboge/client && rsync"
          path: dist/
          remote_path: /var/www/dongboge/client
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: 增量部署 - 传输项目根文件
        if: steps.deploy_strategy.outputs.strategy == 'incremental' || steps.deploy_strategy.outputs.strategy == 'blog_only'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rltz --rsync-path="rsync"
          path: package.json
          remote_path: /var/www/dongboge/package.json
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: 增量部署 - 传输部署脚本
        if: steps.deploy_strategy.outputs.strategy == 'incremental' || steps.deploy_strategy.outputs.strategy == 'blog_only'
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rltz --rsync-path="mkdir -p /var/www/dongboge/deploy && rsync"
          path: deploy/
          remote_path: /var/www/dongboge/deploy
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: 增量部署 - 重启服务
        if: steps.deploy_strategy.outputs.strategy == 'incremental' || steps.deploy_strategy.outputs.strategy == 'blog_only'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            echo "🔄 重启服务..."
            cd /var/www/dongboge

            # 验证关键文件是否存在
            if [ ! -f "server/entry.mjs" ]; then
              echo "❌ 关键文件缺失: server/entry.mjs"
              exit 1
            fi

            # 运行文件修复脚本（如果需要）
            if [ -f "deploy/fix-missing-files.sh" ]; then
              echo "🔧 运行文件修复脚本..."
              chmod +x deploy/fix-missing-files.sh
              ./deploy/fix-missing-files.sh
            fi

            # 确保.env文件存在
            if [ ! -f ".env" ]; then
              echo "📝 创建.env文件..."
              cat > .env << EOF
            PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
            PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
            PUBLIC_CDN_URL=https://cdn.dongboge.cn
            SITE_URL=https://dongboge.cn
            NODE_ENV=production
            HOST=127.0.0.1
            PORT=3000
            EOF
              echo "✅ .env文件已创建"
            fi

            # 使用专门的启动脚本重启服务
            echo "🚀 重启PM2服务..."
            if [ -f "deploy/start-service-with-pm2.sh" ]; then
              chmod +x deploy/start-service-with-pm2.sh
              ./deploy/start-service-with-pm2.sh
              echo "✅ 服务重启成功！"
            else
              echo "❌ 启动脚本不存在: deploy/start-service-with-pm2.sh"
              exit 1
            fi

            # 更新Nginx配置
            echo "🔧 更新Nginx配置..."
            if [ -f "deploy/deploy-nginx-config.sh" ]; then
              chmod +x deploy/deploy-nginx-config.sh
              ./deploy/deploy-nginx-config.sh
              
              # 重载Nginx
              echo "🔄 重载Nginx..."
              sudo systemctl reload nginx
              echo "✅ Nginx配置更新完成"
            else
              echo "⚠️ Nginx配置脚本不存在，跳过配置更新"
            fi

      # ==================== 部署验证 ====================
      - name: 验证部署结果
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          script: |
            echo "🧪 验证部署结果..."
            cd /var/www/dongboge

            # 文件验证
            MJS_COUNT=$(find server -name '*.mjs' 2>/dev/null | wc -l)
            echo "📁 服务端文件: $MJS_COUNT 个.mjs文件"

            # 进程验证
            if ps aux | grep "node.*server/entry.mjs" | grep -v grep >/dev/null; then
              echo "✅ Node.js进程运行正常"
            else
              echo "❌ Node.js进程未运行"
            fi

            # 端口验证
            if netstat -tlnp | grep :3000 >/dev/null; then
              echo "✅ 端口3000正在监听"
            else
              echo "❌ 端口3000未监听"
            fi

            # 服务响应验证
            sleep 2
            LOCAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/ 2>/dev/null || echo "ERROR")
            EXTERNAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/ 2>/dev/null || echo "ERROR")

            echo "🌐 本地响应: $LOCAL_RESPONSE | 外部响应: $EXTERNAL_RESPONSE"

            if [ "$LOCAL_RESPONSE" = "200" ] && [ "$EXTERNAL_RESPONSE" = "200" ]; then
              echo "🎉 部署验证成功！"
              echo "📊 部署策略: ${{ steps.deploy_strategy.outputs.strategy }} | 时间: $(date '+%H:%M:%S')"
            else
              echo "⚠️ 部署可能存在问题"
              if [ -f "logs/server.log" ]; then
                echo "最近日志:"
                tail -5 logs/server.log 2>/dev/null || echo "无法读取日志"
              fi
            fi
