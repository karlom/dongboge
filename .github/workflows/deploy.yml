name: 博客快速部署

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
        - name: 📥 检出代码
          uses: actions/checkout@v4
          with:
            fetch-depth: 2

        - name: 🔍 检测变更类型
          id: detect_changes
          run: |
            # 检查是否只有博客文件变更
            BLOG_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep "src/content/blog/" | wc -l)
            OTHER_CHANGES=$(git diff --name-only HEAD~1 HEAD | grep -v "src/content/blog/" | wc -l)
            
            echo "博客文件变更: $BLOG_CHANGES"
            echo "其他文件变更: $OTHER_CHANGES"
            
            if [ $BLOG_CHANGES -gt 0 ] && [ $OTHER_CHANGES -eq 0 ]; then
              echo "deployment_type=blog_only" >> $GITHUB_OUTPUT
              echo "🔍 检测到：仅博客内容更新"
            else
              echo "deployment_type=full" >> $GITHUB_OUTPUT
              echo "🔍 检测到：代码功能更新"
            fi

        - name: 🏗️ 设置 Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '18'
            cache: 'npm'

        - name: 📦 确保依赖
          run: |
            echo "📦 检查依赖..."
            node scripts/ensure-dependencies.cjs

        - name: 🔨 构建项目
          run: |
            echo "🔨 构建 Astro 项目..."
            npm run build

        - name: 📤 增量上传CDN资源
          run: |
            echo "☁️ 增量更新CDN资源..."
            node scripts/incremental-upload.cjs
          env:
            TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
            TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
            TENCENT_COS_BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
            TENCENT_COS_REGION: ${{ secrets.TENCENT_COS_REGION }}
            CDN_DOMAIN: ${{ secrets.CDN_DOMAIN }}

        - name: 🚀 快速部署 (仅博客更新)
          if: steps.detect_changes.outputs.deployment_type == 'blog_only'
          uses: easingthemes/ssh-deploy@main
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
            ARGS: "-rlgoDzvc -i --exclude=node_modules/ --exclude=.git/"
            SOURCE: "dist/"
            REMOTE_HOST: ${{ secrets.HOST }}
            REMOTE_USER: ${{ secrets.USERNAME }}
            REMOTE_PORT: ${{ secrets.PORT }}
            TARGET: "/var/www/dongboge/"
            SCRIPT_AFTER: |
              echo "🔄 重启服务..."
              sudo systemctl restart dongboge
              echo "✅ 博客更新完成"

        - name: 🚀 完整部署 (功能更新)
          if: steps.detect_changes.outputs.deployment_type == 'full'
          uses: easingthemes/ssh-deploy@main
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
            ARGS: "-rlgoDzvc -i --delete-after --exclude=node_modules/ --exclude=.git/"
            SOURCE: "dist/"
            REMOTE_HOST: ${{ secrets.HOST }}
            REMOTE_USER: ${{ secrets.USERNAME }}
            REMOTE_PORT: ${{ secrets.PORT }}
            TARGET: "/var/www/dongboge/"
            SCRIPT_AFTER: |
              echo "🔧 完整部署处理..."
              sudo chown -R www-data:www-data /var/www/dongboge
              sudo chmod -R 755 /var/www/dongboge
              sudo systemctl restart nginx
              sudo systemctl restart dongboge
              echo "✅ 完整部署完成"

        - name: ✅ 部署完成
          run: |
            echo "🎉 部署成功！"
            echo "🌐 访问: https://dongboge.cn"