name: 简化博客部署

on:
  push:
    branches: [main, master]
    paths:
      - "src/content/blog/**"
      - "public/images/**"
      - "src/assets/**"
      - "scripts/simple-deploy.js"
      - "scripts/modules/**"
      - "public/sitemap.xml"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "强制部署所有内容"
        required: false
        default: false
        type: boolean

jobs:
  simple-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # 获取最近两次提交，用于比较变更

      - name: 设置Node.js环境
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: 安装依赖
        run: |
          echo "📦 安装项目依赖..."
          npm ci --prefer-offline --no-audit --silent --no-fund
          echo "✅ 依赖安装完成"

      - name: 运行简化部署
        env:
          # 服务器配置
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
          PORT: ${{ secrets.PORT || '22' }}

          # CDN配置
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
          TENCENT_COS_BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
          TENCENT_COS_REGION: ap-guangzhou
          CDN_DOMAIN: ${{ secrets.CDN_DOMAIN }}

          # 构建配置
          PUBLIC_CDN_URL: https://cdn.dongboge.cn
          SITE_URL: https://dongboge.cn
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          NODE_ENV: production

          # 强制部署标志
          FORCE_DEPLOY: ${{ github.event.inputs.force_deploy }}
        run: |
          echo "🚀 开始简化部署流程..."

          # 设置SSH密钥
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 添加服务器到known_hosts
          ssh-keyscan -H -p $PORT $HOST >> ~/.ssh/known_hosts

          # 运行简化部署脚本
          node scripts/simple-deploy.js

      - name: 部署后验证
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PORT: ${{ secrets.PORT || '22' }}
        run: |
          echo "🧪 验证部署结果..."

          # 检查网站响应
          sleep 5

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/ || echo "ERROR")
          echo "🌐 网站响应: $RESPONSE"

          if [ "$RESPONSE" = "200" ]; then
            echo "✅ 网站访问正常"
          else
            echo "⚠️ 网站响应异常: $RESPONSE"
          fi

          # 检查sitemap
          SITEMAP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/sitemap.xml || echo "ERROR")
          echo "🗺️ Sitemap响应: $SITEMAP_RESPONSE"

          if [ "$SITEMAP_RESPONSE" = "200" ]; then
            echo "✅ Sitemap访问正常"
          else
            echo "⚠️ Sitemap响应异常: $SITEMAP_RESPONSE"
          fi

      - name: 通知部署结果
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "🎉 简化部署成功完成！"
            echo "📊 部署统计："
            echo "  - 触发方式: ${{ github.event_name }}"
            echo "  - 分支: ${{ github.ref_name }}"
            echo "  - 提交: ${{ github.sha }}"
            echo "  - 网站: https://dongboge.cn"
          else
            echo "❌ 简化部署失败"
            echo "请检查日志并考虑使用完整部署流程"
          fi
