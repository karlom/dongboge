name: ç®€åŒ–åšå®¢éƒ¨ç½²

on:
  push:
    branches: [main, master]
    paths:
      - "src/content/blog/**"
      - "public/images/**"
      - "src/assets/**"
      - "scripts/simple-deploy.js"
      - "scripts/modules/**"
      - "public/sitemap.xml"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "å¼ºåˆ¶éƒ¨ç½²æ‰€æœ‰å†…å®¹"
        required: false
        default: false
        type: boolean

jobs:
  simple-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ï¼Œç”¨äºæ¯”è¾ƒå˜æ›´

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm ci --prefer-offline --no-audit --silent --no-fund
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: è¿è¡Œç®€åŒ–éƒ¨ç½²
        env:
          # æœåŠ¡å™¨é…ç½®
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
          PORT: ${{ secrets.PORT || '22' }}

          # CDNé…ç½®
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
          TENCENT_COS_BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
          TENCENT_COS_REGION: ap-guangzhou
          CDN_DOMAIN: ${{ secrets.CDN_DOMAIN }}

          # æ„å»ºé…ç½®
          PUBLIC_CDN_URL: https://cdn.dongboge.cn
          SITE_URL: https://dongboge.cn
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          NODE_ENV: production

          # å¼ºåˆ¶éƒ¨ç½²æ ‡å¿—
          FORCE_DEPLOY: ${{ github.event.inputs.force_deploy }}
        run: |
          echo "ğŸš€ å¼€å§‹ç®€åŒ–éƒ¨ç½²æµç¨‹..."

          # è®¾ç½®SSHå¯†é’¥
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
          ssh-keyscan -H -p $PORT $HOST >> ~/.ssh/known_hosts

          # è¿è¡Œç®€åŒ–éƒ¨ç½²è„šæœ¬
          node scripts/simple-deploy.js

      - name: éƒ¨ç½²åéªŒè¯
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PORT: ${{ secrets.PORT || '22' }}
        run: |
          echo "ğŸ§ª éªŒè¯éƒ¨ç½²ç»“æœ..."

          # æ£€æŸ¥ç½‘ç«™å“åº”
          sleep 5

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/ || echo "ERROR")
          echo "ğŸŒ ç½‘ç«™å“åº”: $RESPONSE"

          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… ç½‘ç«™è®¿é—®æ­£å¸¸"
          else
            echo "âš ï¸ ç½‘ç«™å“åº”å¼‚å¸¸: $RESPONSE"
          fi

          # æ£€æŸ¥sitemap
          SITEMAP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/sitemap.xml || echo "ERROR")
          echo "ğŸ—ºï¸ Sitemapå“åº”: $SITEMAP_RESPONSE"

          if [ "$SITEMAP_RESPONSE" = "200" ]; then
            echo "âœ… Sitemapè®¿é—®æ­£å¸¸"
          else
            echo "âš ï¸ Sitemapå“åº”å¼‚å¸¸: $SITEMAP_RESPONSE"
          fi

      - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ ç®€åŒ–éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
            echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡ï¼š"
            echo "  - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
            echo "  - åˆ†æ”¯: ${{ github.ref_name }}"
            echo "  - æäº¤: ${{ github.sha }}"
            echo "  - ç½‘ç«™: https://dongboge.cn"
          else
            echo "âŒ ç®€åŒ–éƒ¨ç½²å¤±è´¥"
            echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶è€ƒè™‘ä½¿ç”¨å®Œæ•´éƒ¨ç½²æµç¨‹"
          fi
