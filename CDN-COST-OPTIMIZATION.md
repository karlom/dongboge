# CDN费用优化指南

## 当前问题

每次部署时上传大量静态文件到CDN存储会增加以下费用：

1. **存储费用**：按照实际存储的数据量收费
2. **请求费用**：上传文件时产生的PUT请求费用
3. **回源流量费用**：从COS到CDN的回源流量费用
4. **CDN流量费用**：用户访问CDN时产生的流量费用

## 优化措施

### 1. 增量上传

我们已经实现了增量上传机制，只上传新增或修改的文件，而不是每次都上传所有文件。这通过以下方式实现：

- 使用MD5哈希值比较文件是否发生变化
- 维护上传清单文件`.upload-manifest.json`记录已上传文件的哈希值
- 只上传哈希值发生变化的文件

### 2. 长期缓存策略

我们为静态资源设置了长期缓存策略：

- 设置`Cache-Control: max-age=31536000`（1年）
- 这样浏览器会长期缓存这些资源，减少对CDN的请求次数

### 3. 资源压缩

确保静态资源经过压缩：

- 使用Astro的内置压缩功能
- 考虑使用WebP格式替代JPEG/PNG图片
- 使用现代字体格式如WOFF2替代旧格式

### 4. 避免上传源代码

我们已修改部署流程，确保只上传编译后的静态资源，而不是源代码：

- 只上传`assets`、`fonts`和`images`目录
- 排除`src`目录和其他开发文件

### 5. 按需加载资源

实现按需加载策略：

- 使用`loading="lazy"`属性延迟加载图片
- 考虑实现代码分割，只加载当前页面需要的JavaScript

## 监控与分析

定期检查CDN使用情况：

- 监控存储量变化
- 分析流量使用模式
- 识别热门资源和冷门资源

## 费用估算

腾讯云CDN的费用主要包括：

1. **存储费用**：约0.099元/GB/月
2. **请求费用**：约0.01元/万次请求
3. **流量费用**：根据流量计费或带宽计费，国内流量约0.15元/GB

通过增量上传，我们可以显著减少存储和请求费用。例如，如果网站有1GB静态资源，每月更新10%：

- **全量上传**：每次部署上传1GB，每月4次部署 = 4GB上传量
- **增量上传**：首次上传1GB，之后每次只上传100MB = 1.3GB上传量

这样每月可节省约2.7GB的上传量，减少约70%的上传相关费用。

## 后续优化建议

1. **资源预加载**：使用`<link rel="preload">`预加载关键资源
2. **智能CDN路由**：根据用户地理位置选择最近的CDN节点
3. **自动清理过期资源**：定期清理长时间未使用的资源
4. **图片自适应**：根据设备屏幕大小提供不同分辨率的图片

## 结论

通过实施增量上传和其他优化措施，我们可以显著降低CDN相关费用，同时保持网站性能和用户体验。这些优化不仅减少了费用支出，还提高了部署效率，缩短了部署时间。