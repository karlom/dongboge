---
import { processImagePath } from "../utils/imageUtils";
import { cdnUrl } from "../cdnConfig";

interface Props {
  src: any; // 可以是字符串路径或图像对象
  alt: string;
  class?: string;
  width?: number;
  height?: number;
  title?: string;
  loading?: "lazy" | "eager" | null | undefined;
}

const {
  src,
  alt,
  class: className,
  width,
  height,
  title,
  loading,
} = Astro.props;

// 统一处理所有类型的src为字符串路径
let finalSrc: string;

if (typeof src === "string") {
  // 如果是字符串路径
  // 检查是否已经是完整的URL或已经处理过的路径
  if (
    src.startsWith("http") ||
    src.startsWith("/images/") ||
    src.startsWith("/src/assets/")
  ) {
    // 已经是完整URL或已经处理过的路径，直接使用
    finalSrc = src;
  } else {
    // 需要处理的相对路径
    finalSrc = processImagePath(src);
  }
} else if (src && typeof src === "object" && "src" in src) {
  // 如果是Astro图像对象，直接使用Astro处理后的路径
  // 在生产环境中，Astro会将图片处理并生成带hash的路径
  const isDev = import.meta.env.DEV || process.env.NODE_ENV === "development";

  if (isDev) {
    // 开发环境：使用原始路径
    finalSrc = src.src;
  } else {
    // 生产环境：Astro图像对象的src属性包含了构建后的真实路径
    // 我们需要将路径前缀从默认的 /assets/ 改为 /_astro/，并添加CDN前缀
    let astroPath = src.src;

    // 如果路径以 /assets/ 开头，替换为 /_astro/
    if (astroPath.startsWith("/assets/")) {
      astroPath = astroPath.replace("/assets/", "/_astro/");
    }

    // 使用cdnUrl函数添加CDN前缀
    finalSrc = cdnUrl(astroPath);
  }
} else {
  // 其他情况，转换为字符串后处理
  finalSrc = processImagePath(String(src));
}
---

<div class="image-wrapper" style="text-align: center; margin: 0 auto;">
  <img
    src={finalSrc}
    alt={alt}
    class={className}
    width={width}
    height={height}
    title={title}
    loading={loading}
    style="display: block; margin: 0 auto; max-width: 100%;"
  />
</div>
