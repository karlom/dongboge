# 🚀 部署前最终检查清单

## ✅ 构建验证

- [x] **本地构建成功**: `npm run build` 执行无错误
- [x] **Astro配置正确**: 使用 `server` 模式 + `@astrojs/node` 适配器
- [x] **依赖完整**: 包含 `@astrojs/node` 和 `@supabase/supabase-js`
- [x] **构建输出正确**: 生成 `dist/client/` 和 `dist/server/` 目录

## ✅ 环境变量配置

### 需要在 GitHub Secrets 中设置的变量：

#### Supabase 配置（新增）

```
PUBLIC_SUPABASE_URL=https://znxjpdlohgjdhphcsmju.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpueGpwZGxvaGdqZGhwaGNzbWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNzgzNTEsImV4cCI6MjA2OTg1NDM1MX0.j6Q3ZtQiR8UAfsUEFPrfenrS_2-2zBKN5WZ1ysLXav4
```

#### 腾讯云配置（已有）

```
TENCENT_SECRET_ID=你的腾讯云SecretId
TENCENT_SECRET_KEY=你的腾讯云SecretKey
TENCENT_COS_BUCKET=你的COS存储桶名称
CDN_DOMAIN=cdn.dongboge.cn
```

#### 服务器配置（已有）

```
HOST=你的服务器IP
USERNAME=你的SSH用户名
SSH_PRIVATE_KEY=你的SSH私钥
SSH_PASSPHRASE=你的SSH私钥密码（如果有）
PORT=22
```

## ✅ 关键文件检查

### 配置文件

- [x] **astro.config.mjs**: 使用 `server` 模式和 Node.js 适配器
- [x] **package.json**: 包含所有必需依赖
- [x] **.github/workflows/deploy.yml**: 包含 Supabase 环境变量
- [x] **.env.local**: 本地测试环境变量（不会提交到 Git）

### 功能文件

- [x] **src/lib/supabase.ts**: Supabase 客户端配置
- [x] **src/pages/api/contact.ts**: 联系表单 API 端点
- [x] **src/pages/contact.astro**: 联系表单页面
- [x] **src/components/CustomDropdown.astro**: 自定义下拉组件

## ✅ 部署流程验证

### GitHub Actions 工作流

- [x] **依赖安装**: 包含 `@astrojs/node` 适配器
- [x] **构建环境变量**: 包含 Supabase 配置
- [x] **构建输出**: 生成服务端和客户端文件
- [x] **资源上传**: 静态资源上传到 CDN
- [x] **服务器部署**: HTML 和服务端文件部署到服务器

## ⚠️ 部署注意事项

### 1. 服务器配置更新

部署后需要确保服务器能够运行 Node.js 应用：

```bash
# 在服务器上可能需要安装 PM2 或类似的进程管理器
npm install -g pm2

# 启动应用（如果需要）
pm2 start dist/server/entry.mjs --name "dongboge-blog"
```

### 2. Nginx 配置

确保 Nginx 配置支持 API 端点：

```nginx
# API 端点代理（如果需要）
location /api/ {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

### 3. 环境变量

确保服务器上也有必要的环境变量（通过 GitHub Actions 部署时会自动处理）。

## 🎯 部署后验证清单

部署完成后需要验证：

- [ ] **网站首页正常访问**: https://www.dongboge.cn
- [ ] **联系表单页面正常**: https://www.dongboge.cn/contact
- [ ] **表单提交功能正常**: 测试提交表单
- [ ] **API 端点响应正常**: 检查 `/api/contact` 端点
- [ ] **管理后台正常**: https://www.dongboge.cn/admin/contact-submissions
- [ ] **移动端显示正常**: 测试响应式设计
- [ ] **CDN 资源加载正常**: 检查静态资源是否从 CDN 加载

## 🚨 可能遇到的问题

### 1. 405 错误（API 端点不可用）

- **原因**: 服务器模式配置问题
- **解决**: 确保使用 `server` 模式和正确的适配器

### 2. 环境变量未生效

- **原因**: GitHub Secrets 配置错误
- **解决**: 检查变量名是否完全匹配

### 3. 构建失败

- **原因**: 依赖缺失或配置错误
- **解决**: 检查 `package.json` 和 `astro.config.mjs`

## ✅ 准备就绪

所有检查项目均已通过，可以安全进行部署！

**推荐部署命令**:

```bash
git add .
git commit -m "feat: 添加联系表单功能和Supabase集成，修复构建配置"
git push origin main
```

部署完成后，记得按照验证清单逐项检查功能是否正常。
