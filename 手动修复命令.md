# ğŸ”§ æ‰‹åŠ¨ä¿®å¤ Nginx é…ç½®å‘½ä»¤

å¦‚æœä½ æœ‰æœåŠ¡å™¨SSHè®¿é—®æƒé™ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

## æ–¹æ³•1ï¼šä¸€é”®ä¿®å¤å‘½ä»¤

```bash
# SSHåˆ°æœåŠ¡å™¨
ssh your-username@your-server-ip

# ç›´æ¥åˆ›å»ºå¹¶è¿è¡Œä¿®å¤è„šæœ¬
cd /var/www/dongboge

# å¤‡ä»½å½“å‰é…ç½®
sudo cp /etc/nginx/sites-available/dongboge.conf /etc/nginx/sites-available/dongboge.conf.backup.$(date +%Y%m%d-%H%M%S)

# åˆ›å»ºä¿®å¤çš„é…ç½®æ–‡ä»¶
sudo tee /etc/nginx/sites-available/dongboge.conf > /dev/null << 'EOF'
# ä¿®å¤ç‰ˆNginxé…ç½®
server {
    listen 80;
    server_name dongboge.cn www.dongboge.cn;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name dongboge.cn www.dongboge.cn;

    ssl_certificate /etc/letsencrypt/live/dongboge.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dongboge.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    root /var/www/dongboge;
    index index.html;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # APIç«¯ç‚¹
    location ^~ /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ç®¡ç†åå°
    location ^~ /admin/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # è”ç³»è¡¨å•é¡µé¢ï¼ˆå…³é”®ä¿®å¤ï¼‰
    location = /contact {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€æ–‡ä»¶
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
        access_log off;
    }

    # å…¶ä»–é¡µé¢
    location / {
        try_files $uri $uri/ $uri.html =404;

        location ~* \.html$ {
            expires 1h;
            add_header Cache-Control "public";
        }
    }

    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /var/www/dongboge;
    }
}
EOF

# æµ‹è¯•é…ç½®
sudo nginx -t

# å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‡å¯æœåŠ¡
if [ $? -eq 0 ]; then
    echo "âœ… Nginxé…ç½®æµ‹è¯•é€šè¿‡"

    # åœæ­¢æ—§çš„Node.jsè¿›ç¨‹
    pkill -f "node.*server/entry.mjs" || echo "æ²¡æœ‰è¿è¡Œçš„è¿›ç¨‹"

    # å¯åŠ¨Node.jsæœåŠ¡å™¨
    nohup node server/entry.mjs > server.log 2>&1 &

    # é‡è½½Nginx
    sudo systemctl reload nginx

    echo "âœ… ä¿®å¤å®Œæˆï¼"

    # æµ‹è¯•ç»“æœ
    sleep 3
    echo "æµ‹è¯•ç»“æœ:"
    echo "é¦–é¡µ: $(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/)"
    echo "Contact: $(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/contact)"
else
    echo "âŒ Nginxé…ç½®æµ‹è¯•å¤±è´¥"
fi
```

## æ–¹æ³•2ï¼šä½¿ç”¨GitHub Actions

1. è¿›å…¥GitHubä»“åº“
2. ç‚¹å‡» Actions æ ‡ç­¾
3. é€‰æ‹© "å¼ºåˆ¶ä¿®å¤Nginxé…ç½®"
4. ç‚¹å‡» "Run workflow"

## æ–¹æ³•3ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€

```bash
# æ£€æŸ¥Node.jsè¿›ç¨‹
ps aux | grep "node.*server/entry.mjs"

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep :3000

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -20 /var/www/dongboge/server.log

# æµ‹è¯•æœ¬åœ°Node.jså“åº”
curl -I http://127.0.0.1:3000/contact

# æµ‹è¯•å¤–éƒ¨è®¿é—®
curl -I https://dongboge.cn/contact
```

## ğŸ¯ å…³é”®ä¿®å¤ç‚¹

1. **ç§»é™¤ `must-revalidate`**ï¼šè¿™æ˜¯å¯¼è‡´Nginxé…ç½®æµ‹è¯•å¤±è´¥çš„ä¸»è¦åŸå› 
2. **ç²¾ç¡®åŒ¹é… `/contact`**ï¼šä½¿ç”¨ `location = /contact` ç¡®ä¿ä¼˜å…ˆä»£ç†åˆ°Node.js
3. **å‰ç¼€åŒ¹é…APIè·¯ç”±**ï¼šä½¿ç”¨ `location ^~ /api/` ç¡®ä¿APIè¯·æ±‚æ­£ç¡®ä»£ç†
4. **é‡å¯Node.jsæœåŠ¡å™¨**ï¼šç¡®ä¿æœåŠ¡å™¨æ­£å¸¸è¿è¡Œåœ¨3000ç«¯å£

ä¿®å¤å®Œæˆåï¼Œ`/contact` é¡µé¢åº”è¯¥æ˜¾ç¤ºè”ç³»è¡¨å•è€Œä¸æ˜¯é¦–é¡µå†…å®¹ã€‚
