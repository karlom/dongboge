# 🔧 手动修复 Nginx 配置命令

如果你有服务器SSH访问权限，可以直接运行以下命令：

## 方法1：一键修复命令

```bash
# SSH到服务器
ssh your-username@your-server-ip

# 直接创建并运行修复脚本
cd /var/www/dongboge

# 备份当前配置
sudo cp /etc/nginx/sites-available/dongboge.conf /etc/nginx/sites-available/dongboge.conf.backup.$(date +%Y%m%d-%H%M%S)

# 创建修复的配置文件
sudo tee /etc/nginx/sites-available/dongboge.conf > /dev/null << 'EOF'
# 修复版Nginx配置
server {
    listen 80;
    server_name dongboge.cn www.dongboge.cn;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name dongboge.cn www.dongboge.cn;

    ssl_certificate /etc/letsencrypt/live/dongboge.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dongboge.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    root /var/www/dongboge;
    index index.html;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # API端点
    location ^~ /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 管理后台
    location ^~ /admin/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 联系表单页面（关键修复）
    location = /contact {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
        access_log off;
    }

    # 其他页面
    location / {
        try_files $uri $uri/ $uri.html =404;

        location ~* \.html$ {
            expires 1h;
            add_header Cache-Control "public";
        }
    }

    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /var/www/dongboge;
    }
}
EOF

# 测试配置
sudo nginx -t

# 如果测试通过，重启服务
if [ $? -eq 0 ]; then
    echo "✅ Nginx配置测试通过"

    # 停止旧的Node.js进程
    pkill -f "node.*server/entry.mjs" || echo "没有运行的进程"

    # 启动Node.js服务器
    nohup node server/entry.mjs > server.log 2>&1 &

    # 重载Nginx
    sudo systemctl reload nginx

    echo "✅ 修复完成！"

    # 测试结果
    sleep 3
    echo "测试结果:"
    echo "首页: $(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/)"
    echo "Contact: $(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/contact)"
else
    echo "❌ Nginx配置测试失败"
fi
```

## 方法2：使用GitHub Actions

1. 进入GitHub仓库
2. 点击 Actions 标签
3. 选择 "强制修复Nginx配置"
4. 点击 "Run workflow"

## 方法3：检查当前状态

```bash
# 检查Node.js进程
ps aux | grep "node.*server/entry.mjs"

# 检查端口监听
netstat -tlnp | grep :3000

# 查看服务器日志
tail -20 /var/www/dongboge/server.log

# 测试本地Node.js响应
curl -I http://127.0.0.1:3000/contact

# 测试外部访问
curl -I https://dongboge.cn/contact
```

## 🎯 关键修复点

1. **移除 `must-revalidate`**：这是导致Nginx配置测试失败的主要原因
2. **精确匹配 `/contact`**：使用 `location = /contact` 确保优先代理到Node.js
3. **前缀匹配API路由**：使用 `location ^~ /api/` 确保API请求正确代理
4. **重启Node.js服务器**：确保服务器正常运行在3000端口

修复完成后，`/contact` 页面应该显示联系表单而不是首页内容。
