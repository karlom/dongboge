# 部署问题解决方案

## 问题分析

### 错误原因

你遇到的rsync错误是因为有**多个GitHub Actions工作流同时触发**：

1. **原来的完整部署** (`.github/workflows/deploy.yml`) - 在推送到main分支时触发
2. **新的简化部署** (`.github/workflows/simple-deploy.yml`) - 在推送博客内容时触发

错误日志显示的 `burnett01/rsync-deployments@6.0.0` 是原来完整部署流程中的步骤，它尝试同步 `deploy/` 目录到服务器，但服务器上该目录不存在。

### 具体错误

```
rsync: [receiver] mkstemp "/var/www/***/deploy/.xxx.sh.xxx" failed: No such file or directory (2)
```

这表明rsync尝试在服务器的 `/var/www/***/deploy/` 目录中创建临时文件，但该目录不存在。

## 解决方案

### 1. 已禁用原来的自动部署

我已经修改了 `.github/workflows/deploy.yml`，禁用了自动触发：

```yaml
# 原来的配置（已禁用）
# on:
#   push:
#     branches: [main, master]

# 现在只能手动触发
on:
  workflow_dispatch:
```

### 2. 优化简化部署的触发条件

简化部署现在只在以下文件变更时触发：

- `src/content/blog/**` - 博客文章
- `public/images/**` - 图片资源
- `src/assets/**` - 静态资源
- `scripts/simple-deploy.js` - 部署脚本
- `scripts/modules/**` - 部署模块

### 3. 创建测试脚本

新增了测试脚本来验证简化部署的各个模块：

```bash
# 测试整个简化部署流程（不实际部署）
npm run deploy:test

# 测试各个模块
npm run deploy:test-server  # 测试服务器连接
npm run deploy:test-cdn     # 测试CDN连接
npm run deploy:sitemap      # 只生成sitemap
```

## 使用建议

### 立即测试

1. **本地测试**：

   ```bash
   npm run deploy:test
   ```

   这会检测变更并生成sitemap，但不会实际部署。

2. **测试各个模块**：
   ```bash
   npm run deploy:test-server  # 确认SSH连接正常
   npm run deploy:test-cdn     # 确认CDN配置正确
   ```

### 部署流程选择

#### 日常博客更新（推荐）

- **触发方式**：推送博客文章到main分支
- **自动运行**：简化部署工作流
- **耗时**：1-3分钟
- **适用场景**：博客内容更新、图片资源更新

#### 完整部署（备用）

- **触发方式**：手动在GitHub Actions中运行"日常更新博客"
- **耗时**：5-10分钟
- **适用场景**：代码结构变更、服务器配置更新

### 验证部署成功

部署完成后，检查以下URL：

- 网站首页：https://dongboge.cn
- Sitemap：https://dongboge.cn/sitemap.xml
- 最新博客文章的URL（使用正确的slug）

## 故障排除

### 如果简化部署失败

1. 查看GitHub Actions日志
2. 运行本地测试：`npm run deploy:test`
3. 检查环境变量配置
4. 使用完整部署作为备用方案

### 如果仍有rsync错误

确认没有其他工作流在同时运行：

1. 检查GitHub Actions页面
2. 确认只有"简化博客部署"在运行
3. 如果有其他工作流在运行，手动取消它们

### SSH连接问题

```bash
npm run deploy:test-server
```

这会测试SSH连接并显示详细信息。

### CDN上传问题

```bash
npm run deploy:test-cdn
```

这会验证CDN配置是否正确。

## 下一步

1. **立即运行测试**：`npm run deploy:test`
2. **确认配置正确**：检查环境变量
3. **推送博客内容**：测试自动部署
4. **监控部署结果**：查看GitHub Actions日志

现在你可以安全地推送博客内容，只会触发简化部署流程，避免了原来的rsync错误。
