# ç®€åŒ–éƒ¨ç½²è„šæœ¬è®¾è®¡æ–¹æ¡ˆ

## ç›®æ ‡

åˆ›å»ºä¸€ä¸ªè½»é‡çº§çš„éƒ¨ç½²è„šæœ¬ï¼Œåªåšå¿…è¦çš„æ›´æ–°ï¼š

- åšå®¢å†…å®¹æ›´æ–°
- Sitemapè‡ªåŠ¨ç”Ÿæˆ
- CDNèµ„æºåŒæ­¥

## å½“å‰é—®é¢˜åˆ†æ

ç°æœ‰çš„ `.github/workflows/deploy.yml` è¿‡äºå¤æ‚ï¼š

- åŒ…å«å®Œæ•´éƒ¨ç½²ã€å¢é‡éƒ¨ç½²ã€ä»…åšå®¢ç­‰å¤šç§æ¨¡å¼
- æ¶‰åŠæœåŠ¡å™¨å‡†å¤‡ã€Nginxé…ç½®ã€PM2ç®¡ç†ç­‰é‡å‹æ“ä½œ
- æ¯æ¬¡éƒ¨ç½²è€—æ—¶é•¿ï¼Œæ­¥éª¤å¤š

## ç®€åŒ–æ–¹æ¡ˆè®¾è®¡

### 1. è„šæœ¬ç»“æ„

```
scripts/
â”œâ”€â”€ simple-deploy.js          # ä¸»éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ blog-sync.js             # åšå®¢å†…å®¹åŒæ­¥
â”œâ”€â”€ sitemap-generator.js     # Sitemapç”Ÿæˆå™¨
â””â”€â”€ cdn-sync.js              # CDNèµ„æºåŒæ­¥
```

### 2. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### A. å˜æ›´æ£€æµ‹æ¨¡å—

- æ£€æµ‹ `src/content/blog/` ç›®å½•ä¸‹çš„å˜æ›´
- æ£€æµ‹é™æ€èµ„æºå˜æ›´ï¼ˆimagesã€assetsç­‰ï¼‰
- ç”Ÿæˆå˜æ›´æ¸…å•

#### B. åšå®¢åŒæ­¥æ¨¡å—

- åªæ„å»ºå˜åŒ–çš„åšå®¢é¡µé¢
- å¢é‡æ›´æ–°æœåŠ¡å™¨ä¸Šçš„HTMLæ–‡ä»¶
- ä¿æŒç°æœ‰æœåŠ¡ä¸ä¸­æ–­

#### C. Sitemapç”Ÿæˆæ¨¡å—

- æ‰«ææ‰€æœ‰åšå®¢æ–‡ç« 
- ç”Ÿæˆå®Œæ•´çš„sitemap.xml
- æ›´æ–°lastmodæ—¶é—´æˆ³

#### D. CDNåŒæ­¥æ¨¡å—

- åŸºäºç°æœ‰çš„ `scripts/optimized-cos-upload.cjs`
- åªä¸Šä¼ å˜åŒ–çš„èµ„æºæ–‡ä»¶
- æ™ºèƒ½è·³è¿‡æœªä¿®æ”¹æ–‡ä»¶

### 3. æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[å¼€å§‹] --> B[æ£€æµ‹æ–‡ä»¶å˜æ›´]
    B --> C{æœ‰åšå®¢å˜æ›´?}
    C -->|æ˜¯| D[æ„å»ºå˜æ›´çš„åšå®¢é¡µé¢]
    C -->|å¦| E[æ£€æŸ¥é™æ€èµ„æº]
    D --> F[ç”Ÿæˆæ–°çš„Sitemap]
    F --> G[åŒæ­¥åˆ°æœåŠ¡å™¨]
    E --> H{æœ‰èµ„æºå˜æ›´?}
    H -->|æ˜¯| I[ä¸Šä¼ åˆ°CDN]
    H -->|å¦| J[ç»“æŸ]
    G --> I
    I --> J
```

### 4. å…·ä½“å®ç°æ­¥éª¤

#### æ­¥éª¤1: å˜æ›´æ£€æµ‹

```javascript
// æ£€æµ‹å˜æ›´çš„æ–‡ä»¶
const changedFiles = await detectChanges();
const blogChanges = changedFiles.filter((f) =>
  f.startsWith("src/content/blog/")
);
const assetChanges = changedFiles.filter(
  (f) => f.includes("assets/") || f.includes("images/")
);
```

#### æ­¥éª¤2: å¢é‡æ„å»º

```javascript
// åªæ„å»ºå˜åŒ–çš„å†…å®¹
if (blogChanges.length > 0) {
  await buildChangedBlogPosts(blogChanges);
  await generateSitemap();
}
```

#### æ­¥éª¤3: æœåŠ¡å™¨åŒæ­¥

```javascript
// åªåŒæ­¥å˜åŒ–çš„æ–‡ä»¶
await syncChangedFiles([
  ...blogChanges.map((f) => f.replace("src/content/blog/", "dist/blog/")),
  "dist/sitemap.xml",
]);
```

#### æ­¥éª¤4: CDNåŒæ­¥

```javascript
// å¤ç”¨ç°æœ‰çš„ä¼˜åŒ–ä¸Šä¼ è„šæœ¬
if (assetChanges.length > 0) {
  await runCDNSync(assetChanges);
}
```

### 5. é…ç½®å‚æ•°

```javascript
const config = {
  // æœåŠ¡å™¨é…ç½®
  server: {
    host: process.env.HOST,
    username: process.env.USERNAME,
    deployPath: "/var/www/dongboge/client",
  },

  // CDNé…ç½®
  cdn: {
    bucket: process.env.TENCENT_COS_BUCKET,
    region: process.env.TENCENT_COS_REGION,
    domain: "https://cdn.dongboge.cn",
  },

  // æ„å»ºé…ç½®
  build: {
    incremental: true,
    skipUnchanged: true,
    generateSitemap: true,
  },
};
```

### 6. æ€§èƒ½ä¼˜åŒ–

#### æ—¶é—´ä¼˜åŒ–

- **ç°æœ‰æµç¨‹**: 5-10åˆ†é’Ÿï¼ˆå®Œæ•´æ„å»º+éƒ¨ç½²ï¼‰
- **ç®€åŒ–æµç¨‹**: 1-3åˆ†é’Ÿï¼ˆä»…å˜æ›´å†…å®¹ï¼‰

#### èµ„æºä¼˜åŒ–

- è·³è¿‡æœåŠ¡å™¨é‡å¯
- è·³è¿‡Nginxé…ç½®æ›´æ–°
- è·³è¿‡ä¾èµ–å®‰è£…
- åªä¼ è¾“å˜åŒ–æ–‡ä»¶

### 7. å®‰å…¨è€ƒè™‘

#### å›æ»šæœºåˆ¶

```javascript
// å¤‡ä»½å½“å‰ç‰ˆæœ¬
await backupCurrentVersion();

try {
  await deployChanges();
} catch (error) {
  await rollbackToPreviousVersion();
  throw error;
}
```

#### éªŒè¯æœºåˆ¶

```javascript
// éƒ¨ç½²åéªŒè¯
await validateDeployment([
  "https://dongboge.cn/sitemap.xml",
  "https://dongboge.cn/blog/",
  ...changedBlogUrls,
]);
```

### 8. ä½¿ç”¨æ–¹å¼

#### GitHub Actionsè§¦å‘

```yaml
name: ç®€åŒ–åšå®¢æ›´æ–°
on:
  push:
    paths:
      - "src/content/blog/**"
      - "public/images/**"
      - "src/assets/**"

jobs:
  simple-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: è¿è¡Œç®€åŒ–éƒ¨ç½²
        run: node scripts/simple-deploy.js
```

#### æ‰‹åŠ¨è§¦å‘

```bash
# æœ¬åœ°è¿è¡Œ
npm run deploy:simple

# æˆ–ç›´æ¥è¿è¡Œ
node scripts/simple-deploy.js
```

### 9. ç›‘æ§å’Œæ—¥å¿—

```javascript
// éƒ¨ç½²æŠ¥å‘Š
const report = {
  timestamp: new Date().toISOString(),
  changedFiles: blogChanges.length,
  uploadedAssets: assetChanges.length,
  duration: endTime - startTime,
  status: "success",
};

console.log("ğŸ“Š éƒ¨ç½²æŠ¥å‘Š:", report);
```

### 10. ä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

- **ä¿æŒç°æœ‰çš„å®Œæ•´éƒ¨ç½²æµç¨‹**ä½œä¸ºå¤‡ç”¨
- **æ–°å¢ç®€åŒ–æµç¨‹**ç”¨äºæ—¥å¸¸åšå®¢æ›´æ–°
- **å¯ä»¥éšæ—¶åˆ‡æ¢**å›å®Œæ•´éƒ¨ç½²æ¨¡å¼

## é¢„æœŸæ•ˆæœ

1. **éƒ¨ç½²æ—¶é—´**: ä»5-10åˆ†é’Ÿç¼©çŸ­åˆ°1-3åˆ†é’Ÿ
2. **èµ„æºæ¶ˆè€—**: å‡å°‘80%çš„ä¸å¿…è¦æ“ä½œ
3. **ç¨³å®šæ€§**: å‡å°‘æœåŠ¡ä¸­æ–­é£é™©
4. **ç»´æŠ¤æ€§**: ä»£ç æ›´ç®€æ´ï¼Œæ˜“äºè°ƒè¯•

## å®æ–½å»ºè®®

1. **ç¬¬ä¸€é˜¶æ®µ**: åˆ›å»ºåŸºç¡€çš„å˜æ›´æ£€æµ‹å’Œå¢é‡æ„å»º
2. **ç¬¬äºŒé˜¶æ®µ**: é›†æˆCDNåŒæ­¥å’ŒæœåŠ¡å™¨éƒ¨ç½²
3. **ç¬¬ä¸‰é˜¶æ®µ**: æ·»åŠ ç›‘æ§ã€æ—¥å¿—å’Œå›æ»šæœºåˆ¶
4. **ç¬¬å››é˜¶æ®µ**: ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦ç¬¦åˆä½ çš„éœ€æ±‚ï¼Ÿæˆ‘å¯ä»¥å¼€å§‹å®ç°å…·ä½“çš„è„šæœ¬ä»£ç ã€‚

## âš ï¸ é‡è¦ï¼šSlugå¤„ç†

### é—®é¢˜å‘ç°

ç°æœ‰çš„sitemapç”Ÿæˆè„šæœ¬å­˜åœ¨bugï¼šä½¿ç”¨æ–‡ä»¶åä½œä¸ºURLè·¯å¾„ï¼Œè€Œä¸æ˜¯frontmatterä¸­çš„`slug`å­—æ®µã€‚

### æ­£ç¡®çš„å¤„ç†æ–¹å¼

#### åšå®¢æ–‡ç« ç»“æ„ç¤ºä¾‹

```markdown
---
title: "2024å¹´åæœˆé‡æ–°å‡ºå‘"
slug: "2024-october-fresh-start" # è¿™ä¸ªæ˜¯URLä¸­ä½¿ç”¨çš„è·¯å¾„
pubDate: "Jul 19, 2025"
---
```

#### URLæ˜ å°„å…³ç³»

- **æ–‡ä»¶å**: `2024å¹´åæœˆé‡æ–°å‡ºå‘.md`
- **æ­£ç¡®URL**: `https://dongboge.cn/blog/2024-october-fresh-start/`
- **é”™è¯¯URL**: `https://dongboge.cn/blog/2024å¹´åæœˆé‡æ–°å‡ºå‘/`

### ä¿®å¤æ–¹æ¡ˆ

#### 1. æ­£ç¡®è¯»å–frontmatter

```javascript
function extractSlugFromPost(filePath) {
  const content = fs.readFileSync(filePath, "utf8");
  const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);

  if (frontmatterMatch) {
    const frontmatter = frontmatterMatch[1];
    const slugMatch = frontmatter.match(/slug:\s*['"]?([^'"]+)['"]?/);

    if (slugMatch) {
      return slugMatch[1]; // è¿”å›slugå€¼
    }
  }

  // å¦‚æœæ²¡æœ‰slugï¼Œä½¿ç”¨æ–‡ä»¶åä½œä¸ºfallback
  return path.basename(filePath, ".md");
}
```

#### 2. ç”Ÿæˆæ­£ç¡®çš„sitemap URL

```javascript
posts.forEach((post) => {
  const slug = extractSlugFromPost(post.filePath);
  const url = `${baseUrl}/blog/${slug}/`;

  sitemap += `
    <url>
        <loc>${url}</loc>
        <lastmod>${post.lastmod}</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.6</priority>
    </url>`;
});
```

#### 3. å˜æ›´æ£€æµ‹ä¸­çš„slugå¤„ç†

```javascript
// æ£€æµ‹åšå®¢å˜æ›´æ—¶ï¼Œéœ€è¦åŒæ—¶è¿”å›æ–‡ä»¶è·¯å¾„å’Œslug
function detectBlogChanges() {
  const changedFiles = getChangedFiles();
  const blogChanges = [];

  changedFiles.forEach((file) => {
    if (file.startsWith("src/content/blog/")) {
      const slug = extractSlugFromPost(file);
      blogChanges.push({
        filePath: file,
        slug: slug,
        url: `/blog/${slug}/`,
      });
    }
  });

  return blogChanges;
}
```

### ç®€åŒ–è„šæœ¬ä¸­çš„åº”ç”¨

åœ¨ç®€åŒ–éƒ¨ç½²è„šæœ¬ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ï¼š

1. **å˜æ›´æ£€æµ‹æ—¶**ï¼šè®°å½•æ–‡ä»¶è·¯å¾„å’Œå¯¹åº”çš„slug
2. **sitemapç”Ÿæˆæ—¶**ï¼šä½¿ç”¨slugè€Œä¸æ˜¯æ–‡ä»¶å
3. **æœåŠ¡å™¨åŒæ­¥æ—¶**ï¼šåŒæ­¥åˆ°æ­£ç¡®çš„URLè·¯å¾„

è¿™æ ·å¯ä»¥ç¡®ä¿ç”Ÿæˆçš„sitemapä¸­çš„URLéƒ½æ˜¯å¯è®¿é—®çš„æ­£ç¡®åœ°å€ã€‚
