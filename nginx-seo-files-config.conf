# Nginx配置 - 确保SEO相关文件可以正确访问
# 将以下配置添加到你的nginx server块中

server {
    listen 80;
    listen [::]:80;
    server_name dongboge.com www.dongboge.com;
    
    # 重定向HTTP到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name dongboge.com www.dongboge.com;
    
    # SSL配置（根据你的实际证书路径调整）
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # 网站根目录（根据你的实际部署路径调整）
    root /var/www/dongboge.com/dist;
    index index.html;
    
    # 重要：确保SEO文件可以直接访问
    location = /robots.txt {
        try_files $uri $uri/ =404;
        add_header Content-Type text/plain;
        access_log off;
    }
    
    location = /sitemap.xml {
        try_files $uri $uri/ =404;
        add_header Content-Type application/xml;
        access_log off;
    }
    
    location = /sitemap-index.xml {
        try_files $uri $uri/ =404;
        add_header Content-Type application/xml;
        access_log off;
    }
    
    location = /rss.xml {
        try_files $uri $uri/ =404;
        add_header Content-Type application/xml;
        access_log off;
    }
    
    # Favicon处理
    location = /favicon.ico {
        try_files /Favicon.png =404;
        access_log off;
        log_not_found off;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Astro构建的静态资源
    location /_astro/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # 处理Astro的路由
    location / {
        try_files $uri $uri/ $uri.html /index.html;
    }
    
    # 安全头部
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # 禁止访问敏感文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # WordPress重定向规则（处理旧链接）
    # 处理WordPress的日期格式文章链接
    location ~ ^/(\d{4})/(\d{2})/(\d{2})/([^/]+)/?$ {
        return 301 /blog/$4/;
    }
    
    # 处理WordPress的分类页面
    location ~ ^/category/([^/]+)/?$ {
        return 301 /blog/;
    }
    
    # 处理WordPress的标签页面
    location ~ ^/tag/([^/]+)/?$ {
        return 301 /blog/;
    }
    
    # 处理WordPress的作者页面
    location ~ ^/author/([^/]+)/?$ {
        return 301 /about/;
    }
    
    # 处理WordPress的管理和系统文件
    location ~ ^/wp-(admin|content|includes|json)/ {
        return 301 /;
    }
    
    location ~ \.php$ {
        return 301 /;
    }
    
    # 处理WordPress的RSS订阅
    location ~ ^/(feed|rss|atom)/?$ {
        return 301 /rss.xml;
    }
    
    # 错误页面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # 日志文件
    access_log /var/log/nginx/dongboge.com.access.log;
    error_log /var/log/nginx/dongboge.com.error.log;
}