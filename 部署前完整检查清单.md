# 🚀 部署前完整检查清单

## ✅ 必需的 GitHub Secrets

确保以下 Secrets 已在 GitHub 仓库中正确配置：

### Supabase 配置

- `PUBLIC_SUPABASE_URL` - Supabase 项目 URL
- `PUBLIC_SUPABASE_ANON_KEY` - Supabase 匿名密钥

### 腾讯云 COS 配置

- `TENCENT_SECRET_ID` - 腾讯云 SecretId
- `TENCENT_SECRET_KEY` - 腾讯云 SecretKey
- `TENCENT_COS_BUCKET` - COS 存储桶名称
- `CDN_DOMAIN` - CDN 域名（不含协议前缀）

### 服务器配置

- `HOST` - 服务器 IP 地址
- `USERNAME` - SSH 用户名
- `SSH_PRIVATE_KEY` - SSH 私钥内容
- `SSH_PASSPHRASE` - SSH 私钥密码（如果有）
- `PORT` - SSH 端口（默认 22）

## 🔧 本地验证

在部署前，确保本地构建正常：

```bash
# 1. 清理并重新安装依赖
rm -rf node_modules package-lock.json
npm install

# 2. 本地构建测试
npm run build

# 3. 检查构建输出
ls -la dist/
ls -la dist/client/
ls -la dist/server/

# 4. 验证关键文件
echo "package.json: $([ -f package.json ] && echo '✅' || echo '❌')"
echo "server/entry.mjs: $([ -f dist/server/entry.mjs ] && echo '✅' || echo '❌')"
```

## 📋 部署步骤

### 1. 提交当前代码

```bash
git add .
git commit -m "feat: 完整部署配置，修复服务器模式部署问题"
git push origin main
```

### 2. 手动触发部署

1. 进入 GitHub 仓库
2. 点击 **Actions** 标签
3. 选择 **"完整部署到服务器"**
4. 点击 **"Run workflow"**
5. 选择 `main` 分支
6. 点击 **"Run workflow"** 确认

### 3. 监控部署过程

部署过程大约需要 15-20 分钟，包含以下步骤：

1. **检出代码** (30秒)
2. **安装依赖** (2-3分钟)
3. **构建项目** (1-2分钟)
4. **验证构建输出** (30秒)
5. **上传CDN** (3-5分钟)
6. **部署到服务器** (2-3分钟)
7. **服务器配置** (3-5分钟)

### 4. 部署成功标志

看到以下输出表示部署成功：

```
✅ Node.js服务器启动成功
✅ 本地服务器响应正常
✅ 部署完成！
外部访问响应: 200
Contact页面: 200
```

## 🔍 部署后验证

部署完成后，验证以下功能：

### 网站访问测试

- [ ] 首页：https://dongboge.cn/
- [ ] 关于页面：https://dongboge.cn/about
- [ ] 博客列表：https://dongboge.cn/blog
- [ ] 联系表单：https://dongboge.cn/contact ⭐ **关键测试**

### 功能测试

- [ ] 联系表单显示正确（不是首页内容）
- [ ] 表单可以正常提交
- [ ] API 端点响应正常
- [ ] 管理后台可以访问

### 性能测试

- [ ] 页面加载速度正常
- [ ] 静态资源从 CDN 加载
- [ ] 移动端显示正常

## ⚠️ 常见问题和解决方案

### 问题1：部署卡在某个步骤

**解决**：等待超时后重新运行，或检查 GitHub Actions 日志

### 问题2：Node.js 服务器启动失败

**解决**：检查服务器日志，通常是依赖问题或端口占用

### 问题3：Contact 页面仍显示 404

**解决**：检查 Nginx 配置是否正确更新，Node.js 服务器是否运行

### 问题4：表单提交失败

**解决**：检查 Supabase 环境变量是否正确配置

## 🎯 部署成功后的状态

部署成功后，服务器应该有以下状态：

```bash
# SSH 到服务器检查
cd /var/www/dongboge

# 应该看到这些文件
ls -la
# ✅ package.json
# ✅ node_modules/
# ✅ server/
# ✅ client/
# ✅ .env

# Node.js 进程应该在运行
ps aux | grep "node.*server/entry.mjs"

# 端口 3000 应该被监听
netstat -tlnp | grep :3000
```

## 🚀 开始部署

一切准备就绪后，执行部署：

1. **提交代码**
2. **触发 GitHub Actions**
3. **监控部署过程**
4. **验证部署结果**

预期结果：`https://dongboge.cn/contact` 显示联系表单页面，而不是首页内容。

---

## 📞 如果遇到问题

如果部署失败或有问题：

1. 查看 GitHub Actions 的详细日志
2. 检查服务器上的文件状态
3. 查看 Node.js 服务器日志：`tail -20 /var/www/dongboge/server.log`
4. 提供具体的错误信息，我会帮你进一步诊断

祝部署成功！🎉
