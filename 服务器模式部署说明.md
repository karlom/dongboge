# 🚀 Astro 服务器模式部署说明

## 📋 部署架构变更

### 之前（静态模式）

```
GitHub → 构建静态文件 → 上传到服务器 → Nginx直接服务HTML
```

### 现在（服务器模式）

```
GitHub → 构建客户端+服务端 → 部署到服务器 → Node.js服务器 + Nginx代理
```

## 🔧 关键变更

### 1. 构建输出结构

```
dist/
├── client/          # 静态文件（HTML、CSS、JS、图片等）
└── server/          # Node.js服务器代码
    ├── entry.mjs    # 服务器入口文件
    └── pages/       # 服务端页面和API端点
```

### 2. 部署流程

1. **客户端文件** → `/var/www/dongboge/` (Nginx直接服务)
2. **服务端文件** → `/var/www/dongboge/server/` (Node.js运行)
3. **启动Node.js服务器** → `node server/entry.mjs`
4. **Nginx代理配置** → API和动态页面代理到Node.js

### 3. Nginx配置更新

- **静态文件**: 直接由Nginx服务
- **API端点** (`/api/*`): 代理到Node.js (端口3000)
- **管理后台** (`/admin/*`): 代理到Node.js
- **联系表单** (`/contact`): 代理到Node.js

## 🔍 故障排除

### 403 Forbidden 错误

**原因**:

- Nginx配置未更新
- Node.js服务器未启动
- 文件权限问题

**解决方案**:

```bash
# 检查Node.js服务器状态
ps aux | grep "node.*server/entry.mjs"

# 检查Nginx配置
sudo nginx -t

# 重启服务
sudo systemctl restart nginx

# 手动启动Node.js服务器
cd /var/www/dongboge
node server/entry.mjs
```

### 部署太快问题

**原因**:

- 缓存命中导致跳过构建步骤
- 上传脚本超时被跳过

**解决方案**:

- 检查GitHub Actions日志
- 清除缓存重新部署
- 确保所有步骤正常执行

## 📊 部署验证清单

部署完成后检查：

- [ ] **网站首页**: https://www.dongboge.cn
- [ ] **静态页面**: https://www.dongboge.cn/about
- [ ] **博客页面**: https://www.dongboge.cn/blog
- [ ] **联系表单**: https://www.dongboge.cn/contact
- [ ] **API端点**: https://www.dongboge.cn/api/contact (POST请求)
- [ ] **管理后台**: https://www.dongboge.cn/admin/contact-submissions
- [ ] **Node.js进程**: `ps aux | grep node`
- [ ] **Nginx状态**: `sudo systemctl status nginx`

## 🎯 性能优化

### 1. 进程管理

建议使用PM2管理Node.js进程：

```bash
npm install -g pm2
pm2 start server/entry.mjs --name "dongboge-blog"
pm2 startup
pm2 save
```

### 2. 监控和日志

```bash
# 查看Node.js日志
tail -f server.log

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 查看PM2状态
pm2 status
pm2 logs dongboge-blog
```

## 🔄 回滚方案

如果部署出现问题，可以临时回滚到静态模式：

1. **修改astro.config.mjs**:

```javascript
export default defineConfig({
  output: "static", // 改回静态模式
  // 移除adapter配置
});
```

2. **重新部署**:

```bash
git add astro.config.mjs
git commit -m "rollback: 临时回滚到静态模式"
git push origin main
```

3. **恢复Nginx配置**:
   使用之前的静态模式Nginx配置文件。

---

## ✅ 总结

服务器模式部署更复杂，但提供了：

- ✅ API端点支持
- ✅ 服务端渲染
- ✅ 动态功能
- ✅ 数据库集成

确保所有配置正确后，网站将正常运行并支持联系表单功能。
