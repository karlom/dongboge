# 🔧 405错误修复说明

## 🚨 问题描述

部署后访问表单提交时出现 `405 Not Allowed` 错误，这是因为Astro默认生成静态网站，不支持POST请求到页面路由。

## ✅ 解决方案

### 1. 创建API端点

- 创建了 `src/pages/api/contact.ts` 文件
- 这个API端点专门处理POST请求
- 包含完整的表单验证和数据处理逻辑

### 2. 修改前端提交逻辑

- 更新了 `src/pages/contact.astro` 中的JavaScript代码
- 表单现在提交到 `/api/contact` 端点而不是页面本身
- 使用标准的 `fetch()` API进行提交

### 3. 配置Astro混合模式

- 在 `astro.config.mjs` 中添加了 `output: 'hybrid'`
- 这允许同时支持静态页面和服务端API路由

### 4. 更新部署配置

- 在GitHub Actions中添加了Supabase环境变量
- 确保构建时能正确访问环境变量

## 🔄 工作流程

### 修复前（静态模式）

```
用户提交表单 → POST /contact → 405错误（不支持POST）
```

### 修复后（混合模式）

```
用户提交表单 → POST /api/contact → API处理 → 返回JSON响应
```

## 📁 新增文件

### `src/pages/api/contact.ts`

- 处理POST请求的API端点
- 包含表单验证逻辑
- 调用Supabase函数保存数据
- 返回JSON格式的响应

## 🔧 修改文件

### `src/pages/contact.astro`

- 移除了直接调用Supabase的代码
- 改为向API端点发送POST请求
- 简化了前端逻辑

### `astro.config.mjs`

- 添加了 `output: 'hybrid'` 配置
- 支持静态页面和API路由混合模式

### `.github/workflows/deploy.yml`

- 添加了Supabase环境变量到构建过程
- 确保API端点能正确访问数据库

## 🧪 测试步骤

### 本地测试

1. 运行 `npm run build` 确保构建成功
2. 运行 `npm run preview` 测试生产版本
3. 访问 `/contact` 页面测试表单提交

### 生产环境测试

1. 推送代码触发部署
2. 访问 `https://www.dongboge.cn/contact`
3. 填写并提交表单
4. 确认收到成功消息和飞书通知

## 🎯 预期结果

修复后，表单提交应该：

- ✅ 不再出现405错误
- ✅ 成功提交数据到Supabase
- ✅ 触发飞书通知
- ✅ 显示成功消息给用户

## 📋 部署清单

- [x] 创建API端点文件
- [x] 修改前端提交逻辑
- [x] 更新Astro配置
- [x] 更新部署配置
- [x] 本地构建测试通过
- [ ] 推送代码到GitHub
- [ ] 验证生产环境功能

---

## 🚀 下一步

现在可以推送代码到GitHub，触发重新部署。部署完成后，表单提交功能应该正常工作。
