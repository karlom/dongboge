name: å®Œæ•´éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ðŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm ci --prefer-offline --no-audit --silent

      - name: ç¡®ä¿COS SDKä¾èµ–
        run: |
          echo "ðŸ”§ æ£€æŸ¥COS SDK..."
          chmod +x scripts/ensure-dependencies.cjs
          node scripts/ensure-dependencies.cjs

      - name: æž„å»ºé¡¹ç›®
        env:
          PUBLIC_CDN_URL: https://cdn.dongboge.cn
          SITE_URL: https://dongboge.cn
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          NODE_ENV: production
        run: |
          echo "ðŸ—ï¸ æž„å»ºé¡¹ç›®..."
          npm run build

      - name: éªŒè¯æž„å»ºè¾“å‡º
        run: |
          echo "ðŸ” éªŒè¯æž„å»ºè¾“å‡º..."
          echo "=== æž„å»ºç›®å½•ç»“æž„ ==="
          ls -la dist/
          echo ""
          echo "=== å®¢æˆ·ç«¯æ–‡ä»¶ ==="
          ls -la dist/client/ | head -10
          echo ""
          echo "=== æœåŠ¡ç«¯æ–‡ä»¶ ==="
          ls -la dist/server/ | head -10
          echo ""
          echo "=== æ£€æŸ¥å…³é”®æ–‡ä»¶ ==="
          echo "package.json: $([ -f package.json ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ç¼ºå¤±')"
          echo "server/entry.mjs: $([ -f dist/server/entry.mjs ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ç¼ºå¤±')"

      - name: å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "ðŸ“‹ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p deploy-package

          # å¤åˆ¶æž„å»ºè¾“å‡º
          cp -r dist/* deploy-package/

          # å¤åˆ¶é¡¹ç›®é…ç½®æ–‡ä»¶
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ || echo "âš ï¸ package-lock.json ä¸å­˜åœ¨"

          # å¤åˆ¶éƒ¨ç½²è„šæœ¬
          cp -r deploy deploy-package/

          echo "=== éƒ¨ç½²åŒ…å†…å®¹ ==="
          ls -la deploy-package/

      - name: ä¸Šä¼ é™æ€èµ„æºåˆ°CDN
        timeout-minutes: 10
        run: |
          echo "â˜ï¸ ä¸Šä¼ é™æ€èµ„æºåˆ°CDN..."
          export TENCENT_SECRET_ID=${{ secrets.TENCENT_SECRET_ID }}
          export TENCENT_SECRET_KEY=${{ secrets.TENCENT_SECRET_KEY }}
          export TENCENT_COS_BUCKET=${{ secrets.TENCENT_COS_BUCKET }}
          export TENCENT_COS_REGION=ap-guangzhou
          export CDN_DOMAIN=$(echo ${{ secrets.CDN_DOMAIN }} | sed 's|^https://||' | sed 's|^http://||')

          node scripts/incremental-upload.cjs

      - name: éƒ¨ç½²å®Œæ•´é¡¹ç›®åˆ°æœåŠ¡å™¨
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete --progress
          path: deploy-package/
          remote_path: /var/www/dongboge
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_key_pass: ${{ secrets.SSH_PASSPHRASE }}

      - name: æœåŠ¡å™¨ç«¯é…ç½®å’Œå¯åŠ¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.PORT || '22' }}
          command_timeout: 10m
          script: |
            set -e
            cd /var/www/dongboge

            echo "ðŸ” éªŒè¯éƒ¨ç½²æ–‡ä»¶..."
            echo "=== å½“å‰ç›®å½•å†…å®¹ ==="
            ls -la
            echo ""
            echo "=== æ£€æŸ¥å…³é”®æ–‡ä»¶ ==="
            echo "package.json: $([ -f package.json ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ç¼ºå¤±')"
            echo "server/entry.mjs: $([ -f server/entry.mjs ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ç¼ºå¤±')"
            echo "clientç›®å½•: $([ -d client ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ç¼ºå¤±')"

            if [ ! -f package.json ]; then
              echo "âŒ package.json ç¼ºå¤±ï¼Œéƒ¨ç½²å¤±è´¥"
              exit 1
            fi

            echo "ðŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
            npm install --production --silent

            echo "ðŸ”§ æ›´æ–°Nginxé…ç½®..."
            if [ -f "deploy/nginx-fixed-routing.conf" ]; then
              sudo cp deploy/nginx-fixed-routing.conf /etc/nginx/sites-available/dongboge.conf
              sudo ln -sf /etc/nginx/sites-available/dongboge.conf /etc/nginx/sites-enabled/dongboge.conf
              echo "âœ… Nginxé…ç½®å·²æ›´æ–°"
            else
              echo "âš ï¸ ä½¿ç”¨çŽ°æœ‰Nginxé…ç½®"
            fi

            echo "ðŸ§ª æµ‹è¯•Nginxé…ç½®..."
            sudo nginx -t

            echo "ðŸ”„ è®¾ç½®çŽ¯å¢ƒå˜é‡..."
            cat > .env << EOF
            PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
            PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
            PUBLIC_CDN_URL=https://cdn.dongboge.cn
            SITE_URL=https://dongboge.cn
            NODE_ENV=production
            HOST=127.0.0.1
            PORT=3000
            EOF

            echo "ðŸ›‘ åœæ­¢æ—§çš„Node.jsè¿›ç¨‹..."
            pkill -f "node.*server/entry.mjs" || echo "æ²¡æœ‰è¿è¡Œçš„è¿›ç¨‹"

            echo "ðŸš€ å¯åŠ¨Node.jsæœåŠ¡å™¨..."
            nohup node server/entry.mjs > server.log 2>&1 &

            echo "â³ ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨..."
            sleep 5

            echo "ðŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€..."
            if ps aux | grep "node.*server/entry.mjs" | grep -v grep > /dev/null; then
              echo "âœ… Node.jsæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ"
              
              # æµ‹è¯•æœ¬åœ°å“åº”
              echo "ðŸ§ª æµ‹è¯•æœ¬åœ°æœåŠ¡å™¨å“åº”..."
              LOCAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/contact 2>/dev/null || echo "ERROR")
              echo "æœ¬åœ°å“åº”: $LOCAL_RESPONSE"
              
              if [ "$LOCAL_RESPONSE" = "200" ]; then
                echo "âœ… æœ¬åœ°æœåŠ¡å™¨å“åº”æ­£å¸¸"
              else
                echo "âš ï¸ æœ¬åœ°æœåŠ¡å™¨å“åº”å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
                tail -10 server.log
              fi
            else
              echo "âŒ Node.jsæœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
              echo "é”™è¯¯æ—¥å¿—:"
              tail -20 server.log
              exit 1
            fi

            echo "ðŸ”„ é‡è½½Nginx..."
            sudo systemctl reload nginx

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

            echo ""
            echo "ðŸ§ª æœ€ç»ˆæµ‹è¯•..."
            sleep 3
            EXTERNAL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/contact 2>/dev/null || echo "ERROR")
            echo "å¤–éƒ¨è®¿é—®å“åº”: $EXTERNAL_RESPONSE"

            echo ""
            echo "ðŸ“Š éƒ¨ç½²çŠ¶æ€æ€»ç»“:"
            echo "Node.jsè¿›ç¨‹: $(ps aux | grep 'node.*server/entry.mjs' | grep -v grep | wc -l) ä¸ª"
            echo "ç«¯å£3000ç›‘å¬: $(netstat -tlnp 2>/dev/null | grep :3000 | wc -l) ä¸ª"
            echo "é¦–é¡µçŠ¶æ€: $(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/ 2>/dev/null || echo 'ERROR')"
            echo "Contacté¡µé¢: $(curl -s -o /dev/null -w "%{http_code}" https://dongboge.cn/contact 2>/dev/null || echo 'ERROR')"
